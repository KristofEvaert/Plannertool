<div class="flex flex-col h-[calc(100vh-8rem)] px-4 py-6">
  <!-- Header -->
  <div class="mb-4">
    <div class="flex items-center justify-between mb-4">
      <div class="flex items-center gap-4">
        <a [routerLink]="['/planner/day', date()]">
          <p-button icon="pi pi-arrow-left" label="Back" [text]="true" />
        </a>
        @if (driverDay(); as day) {
          <div class="flex items-center gap-3">
            @if (day.imageUrl) {
              <img
                [src]="day.imageUrl"
                [alt]="day.driverName"
                class="w-10 h-10 rounded-full object-cover"
                onerror="this.style.display='none'"
              />
            }
            <h2 class="text-2xl font-bold">{{ day.driverName }} ‚Äî {{ day.date }}</h2>
          </div>
        } @else {
          <h2 class="text-2xl font-bold">Loading...</h2>
        }
      </div>
    </div>

    @if (error()) {
      <p-message severity="error" [text]="error() || ''" class="mb-4" />
    }

      @if (driverDay(); as day) {
        <div class="flex items-center gap-4 mb-4">
          <p-tag
            [value]="day.dayIsLocked ? 'Day Locked' : 'Day Unlocked'"
            [severity]="day.dayIsLocked ? 'danger' : 'success'"
          />
          @if (day.routeId) {
            <p-tag
              [value]="day.routeIsLocked ? 'Route Locked' : 'Route Unlocked'"
              [severity]="day.routeIsLocked ? 'danger' : 'success'"
            />
          }
          @if (day.startLatitude && day.startLongitude) {
            <div class="text-xs text-gray-500">
              Start: {{ day.startLatitude.toFixed(6) }}, {{ day.startLongitude.toFixed(6) }}
            </div>
            <p-button
              label="Navigate to Start"
              icon="pi pi-map-marker"
              size="small"
              [outlined]="true"
              (onClick)="navigateToStart()"
            />
          }
        </div>

      @if (!day.routeId) {
        <div class="mb-4 p-4 bg-yellow-50 border border-yellow-200 rounded-lg">
          <p class="text-yellow-800">No route generated for this driver/day</p>
        </div>
      } @else {
        <div class="mb-4 flex items-center gap-6 text-sm text-gray-600">
          <span><strong>Stops:</strong> {{ day.stops.length }}</span>
          <span><strong>Total Time:</strong> {{ day.totalMinutes }} min</span>
          <span><strong>Total Distance:</strong> {{ day.totalKm.toFixed(1) }} km</span>
        </div>
      }
    }
  </div>

  <!-- Main content -->
  @if (loading() && !driverDay()) {
    <div class="flex-1 flex items-center justify-center">
      <div class="text-center">Loading...</div>
    </div>
  } @else if (driverDay(); as day) {
    @if (!day.routeId || day.stops.length === 0) {
      <div class="flex-1 flex items-center justify-center">
        <div class="text-center text-gray-500">
          <p class="text-lg">No route planned for this day</p>
        </div>
      </div>
    } @else {
      <div class="flex-1 grid grid-cols-1 lg:grid-cols-2 gap-6 min-h-0">
        <!-- Left: Stops list -->
        <div class="flex flex-col min-h-0">
          <h3 class="text-xl font-semibold mb-4">Route Stops ({{ day.stops.length }})</h3>
          <div class="flex-1 overflow-y-auto space-y-2">
            @for (stop of day.stops; track stop.sequence) {
              <div
                class="p-4 border rounded-lg bg-surface cursor-pointer transition-colors"
                [class.border-primary-500]="selectedStopSequence() === stop.sequence"
                [class.bg-primary-50]="selectedStopSequence() === stop.sequence"
                [class.border-surface-border]="selectedStopSequence() !== stop.sequence"
                (click)="onStopClick(stop.sequence)"
              >
                <div class="flex items-start gap-3">
                  <div class="text-2xl font-bold text-primary">{{ stop.sequence }}</div>
                  <div class="flex-1">
                    <div class="font-semibold">{{ stop.serial }}</div>
                    <div class="text-sm text-gray-600 mt-1 space-y-1">
                      @if (stop.address) {
                        <div class="font-medium text-gray-800 mb-1">üìç {{ stop.address }}</div>
                      }
                      <div class="text-xs text-gray-500">
                        Coordinates: {{ stop.latitude.toFixed(6) }}, {{ stop.longitude.toFixed(6) }}
                      </div>
                      @if (stop.plannedStart) {
                        <div>Start: {{ stop.plannedStart }}</div>
                      }
                      @if (stop.plannedEnd) {
                        <div>End: {{ stop.plannedEnd }}</div>
                      }
                      @if (stop.sequence > 1) {
                        <div>
                          Travel: {{ stop.travelMinutesFromPrev }} min
                          ({{ stop.travelKmFromPrev.toFixed(1) }} km)
                        </div>
                      }
                      <div>Due: {{ stop.dueDate }}</div>
                      @if (stop.fixedDate) {
                        <div class="text-orange-600">Fixed: {{ stop.fixedDate }}</div>
                      }
                      <div>Service: {{ stop.serviceMinutes }} min</div>
                    </div>
                    <div class="mt-2">
                      <p-button
                        label="Navigate to"
                        icon="pi pi-map-marker"
                        size="small"
                        [outlined]="true"
                        (onClick)="navigateToPole(stop.latitude, stop.longitude); $event.stopPropagation()"
                      />
                    </div>
                  </div>
                </div>
              </div>
            }
          </div>
        </div>

        <!-- Right: Map -->
        <div class="flex flex-col min-h-0">
          <h3 class="text-xl font-semibold mb-4">Route Map</h3>
          <div class="flex-1 min-h-0 border border-surface-border rounded-lg overflow-hidden">
            <app-leaflet-map
              [markers]="mapMarkers()"
              [selectedMarkerId]="selectedMarkerId()"
              [polyline]="polylinePoints()"
              [centerOnMarkerId]="centerOnMarkerId()"
              (markerClicked)="onMarkerClicked($event)"
            />
          </div>
          <div class="mt-4 p-3 bg-blue-50 border border-blue-200 rounded-lg text-sm text-blue-800">
            <p>üí° <strong>Note:</strong> Execution actions are available in Driver Run mode.</p>
          </div>
        </div>
      </div>
    }
  }
</div>

<p-toast />
