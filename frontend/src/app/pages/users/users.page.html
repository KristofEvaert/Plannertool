<div class="container mx-auto p-6 space-y-6">
  <div class="flex items-center gap-2">
    <h1 class="text-3xl font-bold text-gray-900">User & Role Management</h1>
    <app-help-manual [sectionId]="'users'" />
  </div>

  <div class="card p-4 space-y-4">
    <input
      pInputText
      placeholder="Search email..."
      class="w-64"
      [ngModel]="emailFilter()"
      (ngModelChange)="emailFilter.set($event)"
    />
    <p-table [value]="filteredUsers()" [loading]="loading()">
      <ng-template pTemplate="header">
        <tr>
          <th>Email</th>
          <th>Name</th>
          <th>Roles</th>
          <th>Owner</th>
          <th>Driver Owner</th>
          <th>Actions</th>
        </tr>
      </ng-template>
      <ng-template let-user pTemplate="body">
        <tr>
          <td>{{ user.email }}</td>
          <td>
            <input
              pInputText
              class="w-48"
              placeholder="Display name"
              [(ngModel)]="user.displayName"
            />
          </td>
          <td>
            <div class="flex flex-col gap-2">
              @for (role of rolesList; track role) {
                <label class="flex items-center gap-1 text-sm">
                  <input
                    type="checkbox"
                    [disabled]="role === 'SuperAdmin' && !isCurrentSuperAdmin()"
                    [checked]="rolesFor(user.id).includes(role)"
                    (change)="toggleRole(user.id, role)"
                  />
                  {{ role }}
                </label>
              }
            </div>
          </td>
          <td>
            <p-select
              optionLabel="label"
              optionValue="value"
              placeholder="Owner for admin/planner"
              class="w-52 mb-2"
              [options]="owners()"
              [disabled]="
                rolesFor(user.id).includes('SuperAdmin') ||
                !(rolesFor(user.id).includes('Admin') || rolesFor(user.id).includes('Planner'))
              "
              (onChange)="staffOwnerSelection[user.id] = $event.value"
              [(ngModel)]="staffOwnerSelection[user.id]"
            />

            <div class="mt-2 space-y-2">
              <input
                pInputText
                placeholder="Driver start address"
                class="w-52"
                [disabled]="!rolesFor(user.id).includes('Driver')"
                [(ngModel)]="driverStartAddressSelection[user.id]"
              />
              <div class="flex gap-2">
                <input
                  type="number"
                  pInputText
                  placeholder="Lat"
                  class="w-24"
                  [disabled]="!rolesFor(user.id).includes('Driver')"
                  [(ngModel)]="driverStartLatitudeSelection[user.id]"
                />
                <input
                  type="number"
                  pInputText
                  placeholder="Lon"
                  class="w-24"
                  [disabled]="!rolesFor(user.id).includes('Driver')"
                  [(ngModel)]="driverStartLongitudeSelection[user.id]"
                />
              </div>
              <div class="text-xs text-gray-500">
                Current: {{ user.driverStartAddress || 'N/A' }} ({{
                  user.driverStartLatitude ?? '—'
                }}, {{ user.driverStartLongitude ?? '—' }})
              </div>
            </div>
          </td>
          <td>
            <p-select
              optionLabel="label"
              optionValue="value"
              placeholder="Owner for driver"
              class="w-52"
              [options]="owners()"
              [disabled]="!rolesFor(user.id).includes('Driver')"
              (onChange)="driverOwnerSelection[user.id] = $event.value"
              [(ngModel)]="driverOwnerSelection[user.id]"
            />
          </td>
          <td>
            <p-button
              label="Save"
              size="small"
              [loading]="loading()"
              (onClick)="assignRoles(user)"
            />
          </td>
        </tr>
      </ng-template>
    </p-table>
  </div>
</div>
