<div class="container mx-auto p-6">
  <!-- Header -->
  <div class="mb-6">
    <div class="flex items-center justify-between mb-4">
      <div class="flex items-center gap-2">
        <h1 class="text-3xl font-bold text-gray-900">Service Locations</h1>
        <app-help-manual [sectionId]="'service-locations'" />
      </div>
      <div class="flex gap-2">
        <p-button
          label="Download Template"
          icon="pi pi-download"
          [outlined]="true"
          (onClick)="downloadTemplate()"
        />
        <input
          #fileInput
          type="file"
          accept=".xlsx,.xls"
          style="display: none"
          (change)="onFileSelected($event)"
        />
        <p-button
          label="Upload Excel"
          icon="pi pi-upload"
          [outlined]="true"
          (onClick)="fileInput.click()"
        />
        <p-button label="Add Service Location" icon="pi pi-plus" (onClick)="openAddDialog()" />
      </div>
    </div>

    <!-- Bulk upload info -->
    <div class="mb-4 p-3 bg-blue-50 border border-blue-200 rounded text-sm text-blue-800">
      <div class="flex items-center gap-4">
        <div class="flex items-center">
          <i class="pi pi-info-circle mr-2"></i>
          <span>Bulk upload. Existing ERP IDs will be updated (status set to Open).</span>
        </div>
        <div class="flex items-center gap-2">
          <label class="text-sm font-medium">Service Type for Bulk:</label>
          <p-select
            optionLabel="name"
            optionValue="id"
            placeholder="Select service type"
            styleClass="w-48"
            [ngModel]="selectedServiceTypeId()"
            [options]="serviceTypes()"
            [appendTo]="'body'"
            (ngModelChange)="selectedServiceTypeId.set($event)"
          />
        </div>
        <div class="flex items-center gap-2">
          <label class="text-sm font-medium">Owner for Bulk:</label>
          <p-select
            optionLabel="name"
            optionValue="id"
            placeholder="Select owner"
            styleClass="w-48"
            [ngModel]="selectedOwnerId()"
            [options]="owners()"
            [appendTo]="'body'"
            (ngModelChange)="onBulkOwnerChange($event)"
          />
        </div>
      </div>
    </div>

    <!-- Filters -->
    <div class="flex flex-wrap items-center gap-4 mb-4">
      <div class="flex items-center gap-2">
        <label class="text-sm font-medium">Status:</label>
        <p-select
          optionLabel="label"
          optionValue="value"
          styleClass="w-32"
          [ngModel]="status()"
          [options]="statusFilterOptions"
          [appendTo]="'body'"
          (ngModelChange)="status.set($event)"
        />
      </div>

      <div class="flex items-center gap-2">
        <label class="text-sm font-medium">Service Type:</label>
        <p-select
          optionLabel="label"
          optionValue="value"
          placeholder="All types"
          styleClass="w-48"
          [ngModel]="serviceTypeId()"
          [options]="serviceTypeFilterOptions()"
          [appendTo]="'body'"
          (ngModelChange)="serviceTypeId.set($event)"
        />
      </div>

      <div class="flex items-center gap-2">
        <label class="text-sm font-medium">Owner:</label>
        <p-select
          optionLabel="label"
          optionValue="value"
          placeholder="All owners"
          styleClass="w-48"
          [ngModel]="ownerId()"
          [options]="ownerFilterOptions()"
          [appendTo]="'body'"
          (ngModelChange)="onOwnerFilterChange($event)"
        />
      </div>

      <div class="flex items-center gap-2">
        <label class="text-sm font-medium">Search:</label>
        <input
          pInputText
          placeholder="Name, address, ERP ID, account, or serial"
          styleClass="w-64"
          [ngModel]="search()"
          (ngModelChange)="search.set($event)"
        />
      </div>

      <div class="flex items-center gap-2">
        <label class="text-sm font-medium">From Due:</label>
        <p-datepicker
          styleClass="w-40"
          [ngModel]="fromDue()"
          [dateFormat]="'yy-mm-dd'"
          [showIcon]="true"
          [appendTo]="'body'"
          (ngModelChange)="fromDue.set($event)"
        />
      </div>

      <div class="flex items-center gap-2">
        <label class="text-sm font-medium">To Due:</label>
        <p-datepicker
          styleClass="w-40"
          [ngModel]="toDue()"
          [dateFormat]="'yy-mm-dd'"
          [showIcon]="true"
          [appendTo]="'body'"
          (ngModelChange)="toDue.set($event)"
        />
      </div>

      <p-button label="Load" icon="pi pi-search" [loading]="loading()" (onClick)="loadData()" />
    </div>
  </div>

  <!-- Table -->
  <p-table
    dataKey="toolId"
    styleClass="p-datatable-striped p-datatable-sm min-w-[1100px]"
    [value]="items()"
    [loading]="loading()"
    [scrollable]="true"
    [paginator]="true"
    [rows]="pageSize()"
    [first]="(page() - 1) * pageSize()"
    [totalRecords]="totalCount()"
    [lazy]="true"
    [rowsPerPageOptions]="[10, 25, 50, 100]"
    [rowHover]="true"
    [expandedRowKeys]="expandedRowKeys()"
    (onLazyLoad)="onPageChange($event)"
    (onRowExpand)="onRowExpand($event)"
    (onRowCollapse)="onRowCollapse($event)"
  >
    <ng-template pTemplate="header">
      <tr>
        <th>Name</th>
        <th>Service Type</th>
        <th>Owner</th>
        <th>Address</th>
        <th>Order Date</th>
        <th style="width: 110px; min-width: 110px; max-width: 110px">Service Minutes</th>
        <th style="width: 190px; min-width: 190px; max-width: 190px">Status</th>
        <th class="text-right">Actions</th>
      </tr>
    </ng-template>
    <ng-template let-item let-rowIndex="rowIndex" let-expanded="expanded" pTemplate="body">
      <tr>
        <td>
          <div class="flex items-start justify-between gap-2">
            <div>
              <div class="font-medium text-gray-900">{{ item.name }}</div>
              <div class="text-xs text-gray-500">ERP {{ item.erpId }}</div>
              @if (item.accountId) {
                <div class="text-xs text-gray-500">Account {{ item.accountId }}</div>
              }
              @if (item.serialNumber) {
                <div class="text-xs text-gray-500">Serial {{ item.serialNumber }}</div>
              }
            </div>
            @if (item.driverInstruction) {
              <i
                pTooltip="{{ item.driverInstruction }}"
                class="pi pi-comment text-blue-600"
                tooltipPosition="top"
              ></i>
            }
          </div>
        </td>
        <td>
          <p-tag severity="info" [value]="item.serviceTypeName || '-'" />
        </td>
        <td>
          <p-tag severity="secondary" [value]="item.ownerName || '-'" />
        </td>
        <td>
          <span
            pTooltip="{{ item.address || '-' }}"
            class="block max-w-[260px] truncate"
            tooltipPosition="top"
          >
            {{ item.address || '-' }}
          </span>
        </td>
        <td>
          <div class="flex items-center gap-2">
            <p-datepicker
              styleClass="w-32"
              [ngModel]="getOrderDateAsDate(item)"
              [dateFormat]="'yy-mm-dd'"
              [showIcon]="false"
              [appendTo]="'body'"
              [baseZIndex]="10000"
              [inputId]="'orderDate_' + rowIndex"
              [disabled]="!canEdit()"
              (ngModelChange)="onOrderDateChange(item, $event)"
            />
            @if (item.priorityDate) {
              <span class="text-xs text-blue-600 font-semibold">(P)</span>
            }
          </div>
        </td>
        <td style="width: 110px; min-width: 110px; max-width: 110px">
          <p-inputNumber
            styleClass="tp-minutes"
            inputStyleClass="tp-minutes-input"
            [min]="1"
            [max]="240"
            [showButtons]="true"
            [useGrouping]="false"
            [disabled]="!canEdit()"
            (ngModelChange)="onServiceMinutesChange(item, $event)"
            [(ngModel)]="item.serviceMinutes"
          />
        </td>
        <td style="width: 190px; min-width: 190px; max-width: 190px">
          <p-select
            optionLabel="label"
            optionValue="value"
            styleClass="tp-status"
            [ngModel]="item.status"
            [options]="statusEditOptions"
            [appendTo]="'body'"
            [disabled]="!canEdit()"
            (ngModelChange)="onStatusChange(item, $event)"
          />
        </td>
        <td class="text-right">
          <div class="flex items-center justify-end gap-2">
            <p-button
              icon="pi pi-pencil"
              size="small"
              severity="secondary"
              pTooltip="Update"
              tooltipPosition="top"
              [outlined]="true"
              [disabled]="!canEdit()"
              (onClick)="openEditDialog(item)"
            />
            <p-button
              type="button"
              pRowToggler
              class="p-button-text p-button-sm"
              [pRowToggler]="item"
              [icon]="expanded ? 'pi pi-chevron-down' : 'pi pi-chevron-right'"
            />
          </div>
        </td>
      </tr>
    </ng-template>
    <ng-template let-item pTemplate="expandedrow">
      <tr>
        <td colspan="8" class="bg-gray-50">
          <div class="p-4 space-y-4">
            @if (getRowDetail(item); as detail) {
              @if (detail.loading) {
                <div class="text-sm text-gray-500">Loading details...</div>
              } @else {
                <div class="grid grid-cols-1 lg:grid-cols-2 gap-4">
                  <div class="rounded border border-gray-200 bg-white p-3">
                    <div class="text-sm font-semibold mb-2">Scheduling</div>
                    <div class="grid grid-cols-2 gap-2 text-sm">
                      <div class="text-gray-500">Due Date</div>
                      <div>{{ item.dueDate | date: 'yyyy-MM-dd' }}</div>
                      <div class="text-gray-500">Priority Date</div>
                      <div>
                        {{ item.priorityDate ? (item.priorityDate | date: 'yyyy-MM-dd') : '-' }}
                      </div>
                      <div class="text-gray-500">Account ID</div>
                      <div>{{ item.accountId || '-' }}</div>
                      <div class="text-gray-500">Serial Number</div>
                      <div>{{ item.serialNumber || '-' }}</div>
                      <div class="text-gray-500">Min Visit Duration</div>
                      <div>{{ detail.constraints?.minVisitDurationMinutes ?? '-' }}</div>
                      <div class="text-gray-500">Max Visit Duration</div>
                      <div>{{ detail.constraints?.maxVisitDurationMinutes ?? '-' }}</div>
                      <div class="text-gray-500">Driver Instruction</div>
                      <div pTooltip="{{ item.driverInstruction || '-' }}" class="truncate">
                        {{ item.driverInstruction || '-' }}
                      </div>
                      <div class="text-gray-500">Remark</div>
                      <div pTooltip="{{ item.remark || '-' }}" class="truncate">
                        {{ item.remark || '-' }}
                      </div>
                    </div>
                  </div>
                  <div class="rounded border border-gray-200 bg-white p-3">
                    <div class="text-sm font-semibold mb-2">Geo</div>
                    <div class="space-y-2 text-sm">
                      <div>
                        <div class="text-gray-500">Address</div>
                        <div pTooltip="{{ item.address || '-' }}" class="truncate">
                          {{ item.address || '-' }}
                        </div>
                      </div>
                      <div class="grid grid-cols-2 gap-2">
                        <div>
                          <div class="text-gray-500">Latitude</div>
                          <div>{{ formatLatLon(item.latitude) }}</div>
                        </div>
                        <div>
                          <div class="text-gray-500">Longitude</div>
                          <div>{{ formatLatLon(item.longitude) }}</div>
                        </div>
                      </div>
                      @if (getMapsLink(item); as mapsLink) {
                        <a
                          class="text-blue-600 underline text-sm inline-flex items-center gap-1"
                          target="_blank"
                          rel="noopener noreferrer"
                          [href]="mapsLink"
                        >
                          <i class="pi pi-map-marker"></i>
                          Open in Maps
                        </a>
                      }
                    </div>
                  </div>
                </div>

                <div class="grid grid-cols-1 lg:grid-cols-2 gap-4">
                  <div class="rounded border border-gray-200 bg-white p-3">
                    <div class="text-sm font-semibold mb-2">Opening Hours</div>
                    @if (detail.hours.length === 0) {
                      <div class="text-sm text-gray-500">Always open (no weekly schedule).</div>
                    } @else {
                      <div class="space-y-1 text-sm">
                        @for (row of detail.hours; track row.dayOfWeek) {
                          <div class="flex items-center justify-between gap-2">
                            <span class="w-24 font-medium">{{ getDayLabel(row.dayOfWeek) }}</span>
                            <span class="text-gray-700">{{ formatOpeningHoursRow(row) }}</span>
                          </div>
                        }
                      </div>
                    }
                  </div>
                  <div class="rounded border border-gray-200 bg-white p-3">
                    <div class="text-sm font-semibold mb-2">Exceptions</div>
                    @if (detail.exceptions.length === 0) {
                      <div class="text-sm text-gray-500">No exceptions.</div>
                    } @else {
                      <div class="space-y-2 text-sm">
                        @for (ex of detail.exceptions; track ex.id ?? ex.date) {
                          <div class="flex flex-wrap items-center justify-between gap-2">
                            <div class="font-medium">{{ ex.date | date: 'yyyy-MM-dd' }}</div>
                            <div class="text-gray-700">{{ formatExceptionRow(ex) }}</div>
                            @if (ex.note) {
                              <div
                                pTooltip="{{ ex.note }}"
                                class="text-gray-500 truncate max-w-[200px]"
                              >
                                {{ ex.note }}
                              </div>
                            }
                          </div>
                        }
                      </div>
                    }
                  </div>
                </div>

                <div class="rounded border border-gray-200 bg-white p-3">
                  <div class="text-sm font-semibold mb-2">Visit Checklist / Instructions</div>
                  @if ((item.extraInstructions?.length ?? 0) === 0) {
                    <div class="text-sm text-gray-500">No instructions.</div>
                  } @else {
                    <ul class="list-disc pl-5 text-sm space-y-1">
                      @for (line of item.extraInstructions ?? []; track line) {
                        <li>{{ line }}</li>
                      }
                    </ul>
                  }
                </div>
              }
            } @else {
              <div class="text-sm text-gray-500">Loading details...</div>
            }
          </div>
        </td>
      </tr>
    </ng-template>

    <ng-template pTemplate="emptymessage">
      <tr>
        <td colspan="8" class="text-center py-8 text-gray-500">No service locations found</td>
      </tr>
    </ng-template>
  </p-table>

  <!-- Add/Edit Dialog -->
  <p-dialog
    [header]="isEditMode() ? 'Edit Service Location' : 'Add Service Location'"
    [modal]="true"
    [style]="{ width: '600px' }"
    [appendTo]="'body'"
    [baseZIndex]="10000"
    (onHide)="showDialog.set(false)"
    [(visible)]="showDialogValue"
  >
    <div class="flex flex-col gap-4">
      <div>
        <label class="block text-sm font-medium mb-1">ErpId *</label>
        <p-inputNumber class="w-full" [useGrouping]="false" [(ngModel)]="form().erpId" />
      </div>
      <div class="grid grid-cols-2 gap-4">
        <div>
          <label class="block text-sm font-medium mb-1">Account ID</label>
          <input pInputText class="w-full" [(ngModel)]="form().accountId" />
        </div>
        <div>
          <label class="block text-sm font-medium mb-1">Serial Number</label>
          <input pInputText class="w-full" [(ngModel)]="form().serialNumber" />
        </div>
      </div>
      <div>
        <label class="block text-sm font-medium mb-1">Name *</label>
        <input pInputText class="w-full" [(ngModel)]="form().name" />
      </div>
      <div>
        <label class="block text-sm font-medium mb-1">Address</label>
        <input pInputText class="w-full" (blur)="onAddressBlur()" [(ngModel)]="form().address" />
      </div>
      <div>
        <label class="block text-sm font-medium mb-1">Driver Instruction</label>
        <textarea
          pTextarea
          class="w-full"
          rows="3"
          placeholder="Optional note shown to the driver"
          [(ngModel)]="form().driverInstruction"
        ></textarea>
      </div>
      <div class="border-t border-gray-200 pt-3">
        <div class="flex items-center justify-between mb-2">
          <div class="text-sm font-semibold">Visit checklist / Instructions</div>
          <p-button
            label="Add line"
            icon="pi pi-plus"
            size="small"
            (onClick)="addInstructionLine()"
          />
        </div>
        @if ((form().extraInstructions?.length ?? 0) === 0) {
          <div class="text-xs text-gray-500">No instructions added yet.</div>
        } @else {
          <div class="space-y-2">
            @for (line of form().extraInstructions ?? []; let idx = $index; track idx) {
              <div class="flex items-center gap-2">
                <input
                  pInputText
                  placeholder="Instruction line"
                  class="w-full"
                  [ngModel]="line"
                  (ngModelChange)="updateInstructionLine(idx, $event)"
                />
                <p-button
                  icon="pi pi-trash"
                  severity="secondary"
                  size="small"
                  [outlined]="true"
                  (onClick)="removeInstructionLine(idx)"
                />
              </div>
            }
          </div>
        }
      </div>
      <div class="grid grid-cols-2 gap-4">
        <div>
          <label class="block text-sm font-medium mb-1">Latitude</label>
          <p-inputNumber
            class="w-full"
            [minFractionDigits]="6"
            [maxFractionDigits]="6"
            (onBlur)="onCoordinatesBlur()"
            [(ngModel)]="form().latitude"
          />
        </div>
        <div>
          <label class="block text-sm font-medium mb-1">Longitude</label>
          <p-inputNumber
            class="w-full"
            [minFractionDigits]="6"
            [maxFractionDigits]="6"
            (onBlur)="onCoordinatesBlur()"
            [(ngModel)]="form().longitude"
          />
        </div>
      </div>
      @if (geoValidationMessage()) {
        <div class="text-xs text-red-600">
          {{ geoValidationMessage() }}
        </div>
      }
      <div class="grid grid-cols-2 gap-4">
        <div>
          <label class="block text-sm font-medium mb-1">Due Date *</label>
          <p-datepicker
            class="w-full"
            [dateFormat]="'yy-mm-dd'"
            [showIcon]="true"
            [(ngModel)]="form().dueDate"
          />
        </div>
        <div>
          <label class="block text-sm font-medium mb-1">Priority Date</label>
          <p-datepicker
            class="w-full"
            [dateFormat]="'yy-mm-dd'"
            [showIcon]="true"
            [(ngModel)]="form().priorityDate"
          />
        </div>
      </div>
      <div>
        <label class="block text-sm font-medium mb-1">Service Minutes</label>
        <p-inputNumber class="w-full" [min]="1" [max]="240" [(ngModel)]="form().serviceMinutes" />
      </div>
      <div class="border-t border-gray-200 pt-3">
        <div class="text-sm font-semibold mb-2">Opening Hours</div>
        <label class="flex items-center gap-2 text-sm mb-3">
          <input type="checkbox" [(ngModel)]="useDefaultOpeningHours" />
          <span>Always open (no weekly schedule)</span>
        </label>
        <div class="space-y-2" [class.opacity-50]="useDefaultOpeningHours()">
          @for (row of openingHours(); track row.dayOfWeek) {
            <div class="flex flex-col gap-1">
              <div class="flex items-center gap-2 text-sm">
                <span class="w-24 font-medium">{{ row.label }}</span>
                <input
                  type="time"
                  class="border rounded px-2 py-1 text-sm"
                  [disabled]="useDefaultOpeningHours() || row.isClosed"
                  [(ngModel)]="row.openTime"
                />
                <span class="text-gray-500">to</span>
                <input
                  type="time"
                  class="border rounded px-2 py-1 text-sm"
                  [disabled]="useDefaultOpeningHours() || row.isClosed"
                  [(ngModel)]="row.closeTime"
                />
                <label class="flex items-center gap-2 text-xs text-gray-600">
                  <input
                    type="checkbox"
                    [ngModel]="row.isClosed"
                    [disabled]="useDefaultOpeningHours()"
                    (ngModelChange)="onOpeningHoursClosedChange(row, $event)"
                  />
                  Closed
                </label>
                <button
                  type="button"
                  class="text-xs text-blue-600 underline"
                  [disabled]="useDefaultOpeningHours() || row.isClosed"
                  (click)="toggleLunchBreak(row)"
                >
                  {{ row.hasLunchBreak ? 'Remove lunch break' : '+ Add lunch break' }}
                </button>
              </div>
              @if (row.hasLunchBreak) {
                <div class="flex items-center gap-2 text-sm pl-24">
                  <input
                    type="time"
                    class="border rounded px-2 py-1 text-sm"
                    [disabled]="useDefaultOpeningHours() || row.isClosed"
                    [(ngModel)]="row.openTime2"
                  />
                  <span class="text-gray-500">to</span>
                  <input
                    type="time"
                    class="border rounded px-2 py-1 text-sm"
                    [disabled]="useDefaultOpeningHours() || row.isClosed"
                    [(ngModel)]="row.closeTime2"
                  />
                </div>
              }
            </div>
          }
        </div>
      </div>
      <div class="border-t border-gray-200 pt-3">
        <div class="flex items-center justify-between mb-2">
          <div class="text-sm font-semibold">Exceptions</div>
          <p-button
            label="Add Exception"
            icon="pi pi-plus"
            size="small"
            (onClick)="addExceptionRow()"
          />
        </div>
        <div class="space-y-2">
          @for (ex of exceptions(); let idx = $index; track idx) {
            <div class="flex flex-wrap items-center gap-2 text-sm">
              <input type="date" class="border rounded px-2 py-1" [(ngModel)]="ex.date" />
              <input
                type="time"
                class="border rounded px-2 py-1"
                [disabled]="ex.isClosed"
                [(ngModel)]="ex.openTime"
              />
              <span class="text-gray-500">to</span>
              <input
                type="time"
                class="border rounded px-2 py-1"
                [disabled]="ex.isClosed"
                [(ngModel)]="ex.closeTime"
              />
              <label class="flex items-center gap-1 text-xs text-gray-600">
                <input type="checkbox" [(ngModel)]="ex.isClosed" />
                Closed
              </label>
              <input
                type="text"
                placeholder="Note"
                class="border rounded px-2 py-1 flex-1 min-w-[160px]"
                [(ngModel)]="ex.note"
              />
              <p-button
                icon="pi pi-trash"
                severity="secondary"
                size="small"
                [outlined]="true"
                (onClick)="removeExceptionRow(idx)"
              />
            </div>
          }
        </div>
      </div>
      <div class="border-t border-gray-200 pt-3">
        <div class="text-sm font-semibold mb-2">Visit Duration Constraints (minutes)</div>
        <div class="grid grid-cols-2 gap-4">
          <div>
            <label class="block text-sm font-medium mb-1">Min Visit Duration</label>
            <p-inputNumber
              class="w-full"
              [ngModel]="constraints().minVisitDurationMinutes"
              [min]="0"
              [max]="240"
              (ngModelChange)="updateMinVisitDuration($event)"
            />
          </div>
          <div>
            <label class="block text-sm font-medium mb-1">Max Visit Duration</label>
            <p-inputNumber
              class="w-full"
              [ngModel]="constraints().maxVisitDurationMinutes"
              [min]="0"
              [max]="240"
              (ngModelChange)="updateMaxVisitDuration($event)"
            />
          </div>
        </div>
      </div>
      <div>
        <label class="block text-sm font-medium mb-1">Owner *</label>
        <p-select
          optionLabel="name"
          optionValue="id"
          class="w-full"
          [ngModel]="form().ownerId"
          [options]="owners()"
          [appendTo]="'body'"
          (ngModelChange)="onFormOwnerChange($event)"
        />
      </div>
      <div>
        <label class="block text-sm font-medium mb-1">Service Type *</label>
        <p-select
          optionLabel="name"
          optionValue="id"
          class="w-full"
          placeholder="Select owner first"
          [ngModel]="form().serviceTypeId"
          [options]="formServiceTypes()"
          [appendTo]="'body'"
          [disabled]="!form().ownerId"
          (ngModelChange)="updateFormServiceTypeId($event)"
        />
      </div>
    </div>
    <ng-template pTemplate="footer">
      <p-button label="Cancel" severity="secondary" (onClick)="showDialog.set(false)" />
      <p-button label="Save" [loading]="loading()" (onClick)="save()" />
    </ng-template>
  </p-dialog>

  <!-- Priority Date Dialog -->
  <p-dialog
    [header]="'Set Priority Date'"
    [modal]="true"
    [style]="{ width: '400px' }"
    [appendTo]="'body'"
    [baseZIndex]="10000"
    (onHide)="showPriorityDialog.set(false)"
    [(visible)]="showPriorityDialogValue"
  >
    @if (selectedItemForPriority(); as item) {
      <div class="flex flex-col gap-4">
        <div>
          <label class="block text-sm font-medium mb-1">Service Location</label>
          <p class="text-gray-700">{{ item.name }} (ERP: {{ item.erpId }})</p>
        </div>
        <div>
          <label class="block text-sm font-medium mb-1">Priority Date</label>
          <p-datepicker
            class="w-full"
            [dateFormat]="'yy-mm-dd'"
            [showIcon]="true"
            [(ngModel)]="priorityDate"
          />
          <p class="text-xs text-gray-500 mt-1">
            Leave empty to clear priority date. Priority date overrides due date for ordering.
          </p>
        </div>
      </div>
    }
    <ng-template pTemplate="footer">
      <p-button
        label="Clear"
        severity="secondary"
        [loading]="loading()"
        (onClick)="priorityDate.set(null); savePriorityDate()"
      />
      <p-button label="Cancel" severity="secondary" (onClick)="showPriorityDialog.set(false)" />
      <p-button label="Save" [loading]="loading()" (onClick)="savePriorityDate()" />
    </ng-template>
  </p-dialog>

  <p-toast />

  <!-- Bulk Upload Result Dialog -->
  <p-dialog
    header="Bulk Upload Result"
    [modal]="true"
    [style]="{ width: '600px' }"
    [appendTo]="'body'"
    [baseZIndex]="10000"
    (onHide)="showBulkResultDialog.set(false)"
    [(visible)]="showBulkResultDialogValue"
  >
    @if (bulkResult(); as result) {
      <div class="flex flex-col gap-4">
        <div class="grid grid-cols-2 gap-4">
          <div class="p-4 bg-green-50 border border-green-200 rounded">
            <div class="text-sm text-green-700 font-medium">Inserted</div>
            <div class="text-2xl font-bold text-green-900">{{ result.inserted }}</div>
          </div>
          <div class="p-4 bg-blue-50 border border-blue-200 rounded">
            <div class="text-sm text-blue-700 font-medium">Updated</div>
            <div class="text-2xl font-bold text-blue-900">{{ result.updated }}</div>
          </div>
        </div>

        @if (result.errors.length > 0) {
          <div>
            <div class="text-sm font-medium text-gray-700 mb-2">
              Errors ({{ result.errors.length }}):
            </div>
            <div class="max-h-64 overflow-y-auto border border-gray-200 rounded">
              <table class="w-full text-sm">
                <thead class="bg-gray-50 sticky top-0">
                  <tr>
                    <th class="px-3 py-2 text-left font-medium text-gray-700">Row</th>
                    <th class="px-3 py-2 text-left font-medium text-gray-700">Message</th>
                  </tr>
                </thead>
                <tbody>
                  @for (error of result.errors; track error.rowRef) {
                    <tr class="border-t border-gray-100">
                      <td class="px-3 py-2 text-gray-600">{{ error.rowRef }}</td>
                      <td class="px-3 py-2 text-red-600">{{ error.message }}</td>
                    </tr>
                  }
                </tbody>
              </table>
            </div>
          </div>
        }
      </div>
    }
    <ng-template pTemplate="footer">
      <p-button label="Close" (onClick)="showBulkResultDialog.set(false)" />
    </ng-template>
  </p-dialog>
</div>
