<div class="map-page-container">
  <div class="map-page-header">
    <div class="flex items-center gap-2">
      <h1 class="page-title">Service Locations Map</h1>
      <app-help-manual [sectionId]="'map'" />
    </div>

    <div class="controls-section">
      <div class="control-group">
        <label for="serviceType" class="control-label"
          >Service Type <span class="required">*</span></label
        >
        <p-multiSelect
          id="serviceType"
          optionLabel="name"
          optionValue="id"
          placeholder="Select up to 5 service types"
          [options]="serviceTypes()"
          [selectionLimit]="5"
          [showToggleAll]="false"
          [filter]="true"
          [style]="{ width: '100%' }"
          (ngModelChange)="onServiceTypeOrOwnerChange()"
          [(ngModel)]="selectedServiceTypeIds"
        />
      </div>

      <div class="control-group">
        <label for="owner" class="control-label">Owner <span class="required">*</span></label>
        <p-select
          id="owner"
          optionLabel="name"
          optionValue="id"
          placeholder="Select owner"
          [options]="owners()"
          [style]="{ width: '100%' }"
          (ngModelChange)="onServiceTypeOrOwnerChange()"
          [(ngModel)]="selectedOwnerId"
        />
      </div>

      <div class="control-group">
        <label for="fromDate" class="control-label">From Date</label>
        <p-datepicker
          id="fromDate"
          dateFormat="yy-mm-dd"
          [showIcon]="true"
          [style]="{ width: '100%' }"
          [appendTo]="'body'"
          [baseZIndex]="1000"
          (ngModelChange)="onDateRangeChange()"
          [(ngModel)]="fromDate"
        />
      </div>

      <div class="control-group">
        <label for="toDate" class="control-label">To Date</label>
        <p-datepicker
          id="toDate"
          dateFormat="yy-mm-dd"
          [showIcon]="true"
          [style]="{ width: '100%' }"
          [appendTo]="'body'"
          [baseZIndex]="1000"
          (ngModelChange)="onDateRangeChange()"
          [(ngModel)]="toDate"
        />
      </div>

      <div class="control-group button-group">
        <div class="button-row">
          <p-button
            label="Load"
            icon="pi pi-search"
            [loading]="loading()"
            [disabled]="selectedServiceTypeIds().length === 0 || !selectedOwnerId() || loading()"
            (onClick)="onLoad()"
          />
          <p-button
            label="Export schedule"
            icon="pi pi-download"
            severity="secondary"
            [disabled]="loading()"
            (onClick)="exportRoutes()"
          />
        </div>
      </div>
    </div>

    @if (mapData()) {
      <div class="info-section">
        <span class="info-badge">
          <i class="pi pi-map-marker mr-1"></i>
          Total points: {{ mapData()!.totalCount }}
          @if (mapData()!.minOrderDate && mapData()!.maxOrderDate) {
            <span> ({{ mapData()!.minOrderDate }} to {{ mapData()!.maxOrderDate }}) </span>
          }
        </span>
      </div>
    }
  </div>

  <div class="map-page-content">
    <div class="map-left-panel">
      @if (mapData()) {
        <div class="map-toolbar">
          <label class="toggle-label">
            <input
              type="checkbox"
              [checked]="showPlannedLocations()"
              (change)="onToggleShowPlannedLocations($event)"
            />
            Show planned locations
          </label>
        </div>
      }

      <div class="map-section">
        <div id="serviceLocationsMap" class="map-element"></div>
      </div>

      <div class="legend-section">
        <div class="legend-urgency">
          <div class="legend-urgency-title">Urgency legend</div>
          <div class="legend-urgency-items">
            @for (item of urgencyLegend; track item) {
              <div class="legend-urgency-item">
                <span class="legend-swatch" [ngStyle]="getLegendSwatchStyle(item.key)"></span>
                <span class="legend-urgency-label">{{ item.label }}</span>
              </div>
            }
          </div>
        </div>

        @if (selectedServiceTypesLegend().length > 0) {
          <div class="legend-service-types">
            @for (st of selectedServiceTypesLegend(); track st) {
              <div class="legend-service-type">
                <span class="legend-shape" [ngClass]="getLegendShapeClass(st.id)"></span>
                <span class="legend-service-type-label">{{ st.name }}</span>
              </div>
            }
          </div>
        }
      </div>
    </div>

    <div class="map-right-panel">
      <div class="drivers-section">
        <div class="drivers-section-header">
          <h2 class="drivers-section-title">Available Drivers</h2>
          <p-button
            label="Auto-generate day"
            icon="pi pi-bolt"
            size="small"
            severity="secondary"
            [loading]="autoGenerateLoading()"
            [disabled]="!selectedOwnerId() || !mapData()?.items?.length"
            (onClick)="autoGenerateForAllDrivers()"
          />
          <p-button
            label="Clear day routes"
            icon="pi pi-trash"
            size="small"
            severity="secondary"
            [disabled]="driverRoutes().size === 0"
            (onClick)="clearAllRoutesForDay()"
          />
        </div>

        <div class="date-picker-container">
          <label for="driverDate" class="date-picker-label">Select Date</label>
          <div class="date-picker-row">
            <p-button
              icon="pi pi-angle-left"
              size="small"
              severity="secondary"
              styleClass="date-nav-button"
              (onClick)="shiftSelectedDate(-1)"
            />
            <div class="date-picker-input">
              <p-datepicker
                id="driverDate"
                dateFormat="yy-mm-dd"
                [showIcon]="true"
                [style]="{ width: '100%' }"
                [appendTo]="'body'"
                [baseZIndex]="1000"
                (onSelect)="onDateChange()"
                [(ngModel)]="selectedDate"
              />
            </div>
            <p-button
              icon="pi pi-angle-right"
              size="small"
              severity="secondary"
              styleClass="date-nav-button"
              (onClick)="shiftSelectedDate(1)"
            />
          </div>
        </div>

        <div class="auto-generate-weights">
          <div class="auto-generate-title">Auto-generate settings</div>
          <div class="weight-row">
            <label class="weight-label">Template</label>
            <p-select
              optionLabel="label"
              optionValue="value"
              styleClass="w-full"
              [options]="routeTemplateOptions"
              [ngModel]="routeTemplate()"
              [appendTo]="'body'"
              (ngModelChange)="routeTemplate.set($event)"
            />
          </div>
          <div class="weight-row">
            <label class="weight-label">Due date priority</label>
            <input type="range" min="0" max="100" step="1" [(ngModel)]="dueDatePriority" />
            <span class="weight-value">{{ dueDatePriority() }}%</span>
          </div>
          <div class="weight-row">
            <label class="weight-label">Worktime deviation</label>
            <input type="range" min="0" max="50" step="1" [(ngModel)]="worktimeDeviationPercent" />
            <span class="weight-value">{{ worktimeDeviationPercent() }}%</span>
          </div>
          <label class="weight-checkbox">
            <input type="checkbox" [(ngModel)]="enforceServiceTypeMatch" />
            <span>Enforce service type match</span>
          </label>
        </div>

        @if (!loadingDrivers()) {
          <div class="drivers-list">
            @for (item of driversWithAvailability(); track trackByDriverId($index, item)) {
              <div
                class="driver-item"
                [class.driver-item-selected]="isDriverExpanded(item)"
                [class.driver-item-unavailable]="!item.availability"
                [class.driver-item-overbooked]="isDriverOverbooked(item)"
                [class.driver-item-selected.driver-item-overbooked]="
                  isDriverOverbooked(item) && isDriverExpanded(item)
                "
              >
                <div
                  class="driver-header"
                  role="button"
                  tabindex="0"
                  (click)="toggleDriverCard(item, $event)"
                  (keydown.enter)="toggleDriverCard(item, $event)"
                  (keydown.space)="toggleDriverCard(item, $event)"
                >
                  <div class="driver-content">
                    <span class="driver-name">{{ item.driver.name }}</span>
                    <span class="driver-hours">{{ getDriverHeaderDuration(item) }}</span>
                    <span class="driver-availability">
                      <i class="pi pi-clock mr-1"></i>
                      {{ getDriverHeaderTimeRange(item) }}
                    </span>
                  </div>
                  <i
                    class="driver-toggle-icon pi"
                    [ngClass]="isDriverExpanded(item) ? 'pi-chevron-down' : 'pi-chevron-right'"
                  ></i>
                </div>
                @if (isDriverExpanded(item)) {
                  <div
                    class="driver-route-info"
                    (click)="$event.stopPropagation()"
                    (mousedown)="$event.stopPropagation()"
                    (touchstart)="$event.stopPropagation()"
                  >
                    <div class="route-header">
                      <h4 class="route-title">
                        <i class="pi pi-map mr-1"></i>
                        Route
                      </h4>
                    </div>
                    <div class="route-summary">
                      <i class="pi pi-map-marker mr-1"></i>
                      <span
                        >{{
                          getLocationCount(getCurrentRouteForDisplay()!.waypoints)
                        }}
                        location(s)</span
                      >
                      @if (getCurrentRouteForDisplay()!.waypoints.length > 1) {
                        <span class="route-time">
                          <i class="pi pi-clock mr-1"></i>
                          {{ formatRouteTime(getCurrentRouteForDisplay()!.totalTimeMinutes) }}
                          <span style="opacity: 0.75">
                            ({{
                              formatRouteTime(getTotalServiceMinutes(getCurrentRouteForDisplay()!))
                            }}
                            service +
                            {{ formatRouteTime(getDriveMinutes(getCurrentRouteForDisplay()!)) }}
                            driving)
                          </span>
                        </span>
                      }
                      @if (getCurrentRouteForDisplay()!.waypoints.length > 1) {
                        <span class="route-distance">
                          <i class="pi pi-map mr-1"></i>
                          @if (isRouteCalculating(getCurrentRouteForDisplay())) {
                            Calculating...
                          } @else {
                            {{ getCurrentRouteForDisplay()!.totalDistanceKm.toFixed(1) }} km
                          }
                        </span>
                      }
                    </div>
                    @if (getCurrentRouteForDisplay()!.waypoints.length > 0) {
                      <div class="route-locations">
                        @if (getStartWaypoint(getCurrentRouteForDisplay()!); as startWp) {
                          <div
                            class="route-location-item route-start route-location-clickable"
                            (click)="toggleStartOverrideEditor()"
                          >
                            <span class="route-location-label">Start</span>
                            <span class="route-location-name">{{ startWp.name }}</span>
                            <span
                              class="route-location-address"
                              [title]="getRouteEndpointCoords(getCurrentRouteForDisplay(), 'start')"
                            >
                              {{ getRouteEndpointAddress(getCurrentRouteForDisplay(), 'start') }}
                            </span>
                            @if (showStartOverrideEditor) {
                              <div class="route-override-editor">
                                <input
                                  type="text"
                                  class="route-override-input"
                                  placeholder="Start address (optional)"
                                  (click)="$event.stopPropagation()"
                                  [(ngModel)]="startOverrideAddress"
                                />
                                <div class="route-override-coords">
                                  <input
                                    type="number"
                                    class="route-override-input"
                                    placeholder="Lat"
                                    (click)="$event.stopPropagation()"
                                    [(ngModel)]="startOverrideLatitude"
                                  />
                                  <input
                                    type="number"
                                    class="route-override-input"
                                    placeholder="Lng"
                                    (click)="$event.stopPropagation()"
                                    [(ngModel)]="startOverrideLongitude"
                                  />
                                </div>
                                <div class="route-override-actions">
                                  <button
                                    type="button"
                                    class="route-override-btn"
                                    (click)="$event.stopPropagation(); applyStartOverride()"
                                  >
                                    Apply
                                  </button>
                                  <button
                                    type="button"
                                    class="route-override-btn secondary"
                                    (click)="$event.stopPropagation(); clearStartOverride()"
                                  >
                                    Reset
                                  </button>
                                </div>
                              </div>
                            }
                          </div>
                        }
                        @if (getStopSchedule(getCurrentRouteForDisplay()); as stopSchedule) {
                          <div>
                            @for (
                              waypoint of getLocationWaypoints(getCurrentRouteForDisplay()!);
                              track waypoint;
                              let i = $index
                            ) {
                              <div class="route-location-item">
                                <button
                                  type="button"
                                  class="route-location-number route-location-number-btn"
                                  title="Select stop to reorder"
                                  (click)="$event.stopPropagation(); toggleSelectedRouteStop(i)"
                                >
                                  {{ i + 1 }}
                                </button>
                                @if (selectedRouteStopIndex() === i) {
                                  <div class="route-reorder-controls">
                                    <button
                                      type="button"
                                      class="route-reorder-btn"
                                      title="Move up"
                                      [disabled]="i === 0"
                                      (click)="$event.stopPropagation(); moveSelectedStop('up')"
                                    >
                                      <i class="pi pi-arrow-up"></i>
                                    </button>
                                    <button
                                      type="button"
                                      class="route-reorder-btn"
                                      title="Move down"
                                      [disabled]="
                                        i ===
                                        getLocationWaypoints(getCurrentRouteForDisplay()!).length -
                                          1
                                      "
                                      (click)="$event.stopPropagation(); moveSelectedStop('down')"
                                    >
                                      <i class="pi pi-arrow-down"></i>
                                    </button>
                                  </div>
                                }
                                <div class="route-location-main">
                                  <span class="route-location-name">{{ waypoint.name }}</span>
                                  @if (waypoint.address) {
                                    <span
                                      class="route-location-address route-location-address-compact"
                                      [title]="waypoint.address"
                                    >
                                      {{ waypoint.address }}
                                    </span>
                                  }
                                </div>
                                @if (stopSchedule[i]?.label) {
                                  <span class="route-location-time">
                                    {{ stopSchedule[i]?.label }}
                                  </span>
                                }
                                @if (!stopSchedule[i]?.label && waypoint.serviceMinutes) {
                                  <span class="route-location-time">
                                    ({{ waypoint.serviceMinutes }}m)
                                  </span>
                                }
                              </div>
                            }
                          </div>
                        }
                        @if (getEndWaypoint(getCurrentRouteForDisplay()!); as endWp) {
                          <div
                            class="route-location-item route-end route-location-clickable"
                            (click)="toggleEndOverrideEditor()"
                          >
                            <span class="route-location-label">End</span>
                            <span class="route-location-name">{{ endWp.name }}</span>
                            <span
                              class="route-location-address"
                              [title]="getRouteEndpointCoords(getCurrentRouteForDisplay(), 'end')"
                            >
                              {{ getRouteEndpointAddress(getCurrentRouteForDisplay(), 'end') }}
                            </span>
                            @if (showEndOverrideEditor) {
                              <div class="route-override-editor">
                                <input
                                  type="text"
                                  class="route-override-input"
                                  placeholder="End address (optional)"
                                  (click)="$event.stopPropagation()"
                                  [(ngModel)]="endOverrideAddress"
                                />
                                <div class="route-override-coords">
                                  <input
                                    type="number"
                                    class="route-override-input"
                                    placeholder="Lat"
                                    (click)="$event.stopPropagation()"
                                    [(ngModel)]="endOverrideLatitude"
                                  />
                                  <input
                                    type="number"
                                    class="route-override-input"
                                    placeholder="Lng"
                                    (click)="$event.stopPropagation()"
                                    [(ngModel)]="endOverrideLongitude"
                                  />
                                </div>
                                <div class="route-override-actions">
                                  <button
                                    type="button"
                                    class="route-override-btn"
                                    (click)="$event.stopPropagation(); applyEndOverride()"
                                  >
                                    Apply
                                  </button>
                                  <button
                                    type="button"
                                    class="route-override-btn secondary"
                                    (click)="$event.stopPropagation(); clearEndOverride()"
                                  >
                                    Reset
                                  </button>
                                </div>
                              </div>
                            }
                          </div>
                        }
                      </div>
                    }
                    @if (
                      isBuildingRoute() &&
                      getCurrentRouteForDisplay()?.driver?.toolId === item.driver.toolId
                    ) {
                      <div class="route-actions">
                        <p-button
                          label="Clear Route"
                          icon="pi pi-times"
                          severity="secondary"
                          size="small"
                          [style]="{ width: '100%', marginTop: '0.5rem' }"
                          (onClick)="clearRoute()"
                        />
                      </div>
                    }
                  </div>
                }
              </div>
            }
            @if (driversWithAvailability().length === 0) {
              <div class="no-drivers">
                <i class="pi pi-info-circle mr-2"></i>
                No drivers found
              </div>
            }
          </div>
        }

        @if (loadingDrivers()) {
          <div class="drivers-loading">
            <i class="pi pi-spin pi-spinner mr-2"></i>
            Loading drivers...
          </div>
        }
      </div>
    </div>
  </div>
</div>

<p-toast />

<p-dialog
  [modal]="true"
  [closable]="true"
  [style]="{ width: '420px' }"
  [header]="templateDialogMode() === 'update' ? 'Update weight template' : 'Save weight template'"
  [(visible)]="showTemplateNameDialogValue"
>
  <div class="flex flex-col gap-4">
    <div>
      <label class="block text-sm font-semibold mb-1">Template name</label>
      <input pInputText class="w-full" placeholder="Enter a name" [(ngModel)]="newTemplateName" />
    </div>
  </div>
  <ng-template pTemplate="footer">
    <div class="flex justify-end gap-2">
      <p-button
        label="Cancel"
        severity="secondary"
        [outlined]="true"
        (onClick)="showTemplateNameDialog.set(false)"
      />
      <p-button
        label="Save"
        [loading]="templateSaveLoading()"
        (onClick)="saveTemplateFromDialog()"
      />
    </div>
  </ng-template>
</p-dialog>

<p-dialog
  header="Some locations were not added"
  [modal]="true"
  [closable]="true"
  [style]="{ width: '520px' }"
  [(visible)]="showBulkAddDialogValue"
>
  <div class="bulk-add-dialog">
    <div class="bulk-add-subtitle">These locations were skipped during the bulk add.</div>
    @if (bulkAddRejections().length > 0) {
      <div class="bulk-add-list">
        @for (item of bulkAddRejections(); track item) {
          <div class="bulk-add-item">
            <div class="bulk-add-name">{{ item.name }}</div>
            <div class="bulk-add-reason">{{ item.reason }}</div>
            @if (item.address) {
              <div class="bulk-add-address">{{ item.address }}</div>
            }
          </div>
        }
      </div>
    }
  </div>
  <ng-template pTemplate="footer">
    <div class="flex justify-end">
      <p-button
        label="Close"
        severity="secondary"
        [outlined]="true"
        (onClick)="showBulkAddDialog.set(false)"
      />
    </div>
  </ng-template>
</p-dialog>
