<div class="flex flex-col min-h-screen overflow-visible bg-gray-100">
  <div class="bg-white px-8 py-6 border-b border-gray-200 shadow-sm shrink-0">
    <div class="flex items-center gap-2">
      <h1 class="text-3xl font-bold text-gray-900 m-0">Service Locations Map</h1>
      <app-help-manual [sectionId]="'map'" />
    </div>

    <div class="grid grid-cols-[repeat(auto-fit,minmax(180px,1fr))] gap-4 items-end mb-4">
      <div class="flex flex-col gap-2">
        <label for="serviceType" class="text-sm font-medium text-gray-700 m-0"
          >Service Type <span class="text-red-500">*</span></label
        >
        <p-multiSelect
          id="serviceType"
          optionLabel="name"
          optionValue="id"
          placeholder="Select up to 5 service types"
          class="w-full"
          [options]="serviceTypes()"
          [selectionLimit]="5"
          [showToggleAll]="false"
          [filter]="true"
          (ngModelChange)="onServiceTypeOrOwnerChange()"
          [(ngModel)]="selectedServiceTypeIds"
        />
      </div>

      <div class="flex flex-col gap-2">
        <label for="owner" class="text-sm font-medium text-gray-700 m-0"
          >Owner <span class="text-red-500">*</span></label
        >
        <p-select
          id="owner"
          optionLabel="name"
          optionValue="id"
          placeholder="Select owner"
          [options]="owners()"
          [style]="{ width: '100%' }"
          (ngModelChange)="onServiceTypeOrOwnerChange()"
          [(ngModel)]="selectedOwnerId"
        />
      </div>

      <div class="flex flex-col gap-2">
        <label for="fromDate" class="text-sm font-medium text-gray-700 m-0">From Date</label>
        <p-datepicker
          id="fromDate"
          dateFormat="yy-mm-dd"
          [showIcon]="true"
          [style]="{ width: '100%' }"
          [appendTo]="'body'"
          [baseZIndex]="1000"
          (ngModelChange)="onDateRangeChange()"
          [(ngModel)]="fromDate"
        />
      </div>

      <div class="flex flex-col gap-2">
        <label for="toDate" class="text-sm font-medium text-gray-700 m-0">To Date</label>
        <p-datepicker
          id="toDate"
          dateFormat="yy-mm-dd"
          [showIcon]="true"
          [style]="{ width: '100%' }"
          [appendTo]="'body'"
          [baseZIndex]="1000"
          (ngModelChange)="onDateRangeChange()"
          [(ngModel)]="toDate"
        />
      </div>

      <div class="flex flex-col gap-2 items-stretch">
        <div class="flex justify-end gap-3 items-center">
          <p-button
            label="Load"
            icon="pi pi-search"
            [loading]="loading()"
            [disabled]="selectedServiceTypeIds().length === 0 || !selectedOwnerId() || loading()"
            (onClick)="onLoad()"
          />
          <p-button
            label="Export schedule"
            icon="pi pi-download"
            severity="secondary"
            [disabled]="loading()"
            (onClick)="exportRoutes()"
          />
        </div>
      </div>
    </div>

    @if (mapData()) {
      <div class="mt-4">
        <span
          class="inline-flex items-center bg-linear-to-br from-blue-50 to-blue-100 text-blue-900 px-4 py-2 rounded-md text-sm font-medium border border-blue-500"
        >
          <i class="pi pi-map-marker mr-1"></i>
          Total points: {{ mapData()!.totalCount }}
          @if (mapData()!.minOrderDate && mapData()!.maxOrderDate) {
            <span> ({{ mapData()!.minOrderDate }} to {{ mapData()!.maxOrderDate }}) </span>
          }
        </span>
      </div>
    }
  </div>

  <div
    class="flex flex-col xl:flex-row shrink-0 overflow-visible gap-4 xl:gap-6 p-4 xl:p-6 items-start"
  >
    <div class="w-full xl:flex-[0_0_65%] min-w-0 xl:sticky xl:top-6 self-start">
      <app-map-with-legend
        [mapData]="mapData()"
        [serviceTypes]="serviceTypes()"
        [selectedServiceTypeIds]="selectedServiceTypeIds()"
        [selectedDate]="selectedDate()"
        [driverRoutes]="driverRoutes()"
        [selectedDriverToolId]="selectedDriver()?.driver?.toolId ?? null"
        (locationClick)="onLocationClick($event)"
        (locationDoubleClick)="toggleLocationInRoute($event)"
        [(showPlannedLocations)]="showPlannedLocations"
      />
    </div>

    <div
      class="flex-1 bg-white rounded-lg shadow-sm border border-gray-200 p-6 overflow-visible flex flex-col"
    >
      <div class="flex flex-col h-full min-h-0">
        <div class="flex items-center justify-between gap-2 mb-4">
          <h2 class="text-xl font-semibold text-gray-800 m-0">Available Drivers</h2>
          <p-button
            label="Auto-generate day"
            icon="pi pi-bolt"
            size="small"
            severity="secondary"
            [loading]="autoGenerateLoading()"
            [disabled]="!selectedOwnerId() || !mapData()?.items?.length"
            (onClick)="autoGenerateForAllDrivers()"
          />
          <p-button
            label="Clear day routes"
            icon="pi pi-trash"
            size="small"
            severity="secondary"
            [disabled]="driverRoutes().size === 0"
            (onClick)="clearAllRoutesForDay()"
          />
        </div>

        <div class="mb-6">
          <label for="driverDate" class="block text-sm font-medium text-gray-700 mb-2"
            >Select Date</label
          >
          <div class="flex items-center gap-2">
            <p-button
              icon="pi pi-angle-left"
              size="small"
              severity="secondary"
              styleClass="w-8 h-8"
              (onClick)="shiftSelectedDate(-1)"
            />
            <div class="flex-1">
              <p-datepicker
                id="driverDate"
                dateFormat="yy-mm-dd"
                [showIcon]="true"
                [style]="{ width: '100%' }"
                [appendTo]="'body'"
                [baseZIndex]="1000"
                (onSelect)="onDateChange()"
                [(ngModel)]="selectedDate"
              />
            </div>
            <p-button
              icon="pi pi-angle-right"
              size="small"
              severity="secondary"
              styleClass="w-8 h-8"
              (onClick)="shiftSelectedDate(1)"
            />
          </div>
        </div>

        <div class="mt-3 p-3 border border-gray-300 border-opacity-15 rounded-lg bg-slate-50">
          <div class="text-xs font-semibold uppercase tracking-wider text-slate-700 mb-2">
            Auto-generate weights
          </div>
          <div class="grid grid-cols-[70px_1fr_36px] gap-2 items-center mb-1.5">
            <label class="text-xs text-slate-700">Template</label>
            <p-select
              optionLabel="label"
              optionValue="value"
              placeholder="Manual weights"
              styleClass="w-full"
              [options]="weightTemplateOptions()"
              [ngModel]="selectedWeightTemplateId()"
              [showClear]="true"
              [appendTo]="'body'"
              (ngModelChange)="onWeightTemplateChange($event)"
            />
          </div>
          @if (canManageTemplates()) {
            <div class="flex gap-2 my-1 mb-2.5">
              <p-button
                label="Save as new"
                icon="pi pi-save"
                size="small"
                severity="secondary"
                [style]="{ flex: '1 1 0' }"
                (onClick)="openNewTemplateDialog()"
              />
              <p-button
                label="Update template"
                icon="pi pi-refresh"
                size="small"
                severity="secondary"
                [disabled]="!canUpdateSelectedTemplate()"
                [style]="{ flex: '1 1 0' }"
                (onClick)="openRenameTemplateDialog()"
              />
            </div>
          }
          @if (weightCost() === 0 || showInactiveWeights()) {
            <div class="grid grid-cols-[70px_1fr_36px] gap-2 items-center mb-1.5">
              <label class="text-xs text-slate-700">
                Driver Time
                @if (weightCost() > 0) {
                  <span class="ml-1 text-gray-400 font-medium">(suppressed)</span>
                }
              </label>
              <input type="range" min="0" max="100" step="1" [(ngModel)]="weightTime" />
              <span class="text-xs text-right text-gray-900">{{ activeWeightTime() }}%</span>
            </div>
          }
          @if (weightCost() === 0 || showInactiveWeights()) {
            <div class="grid grid-cols-[70px_1fr_36px] gap-2 items-center mb-1.5">
              <label class="text-xs text-slate-700">
                Distance
                @if (weightCost() > 0) {
                  <span class="ml-1 text-gray-400 font-medium">(suppressed)</span>
                }
              </label>
              <input type="range" min="0" max="100" step="1" [(ngModel)]="weightDistance" />
              <span class="text-xs text-right text-gray-900">{{ activeWeightDistance() }}%</span>
            </div>
          }
          <div class="grid grid-cols-[70px_1fr_36px] gap-2 items-center mb-1.5">
            <label class="text-xs text-slate-700">Due Date</label>
            <input type="range" min="0" max="100" step="1" [(ngModel)]="weightDate" />
            <span class="text-xs text-right text-gray-900">{{ activeWeightDate() }}%</span>
          </div>
          <div class="grid grid-cols-[70px_1fr_36px] gap-2 items-center mb-1.5">
            <label class="text-xs text-slate-700">Cost</label>
            <input type="range" min="0" max="100" step="1" [(ngModel)]="weightCost" />
            <span class="text-xs text-right text-gray-900">{{ activeWeightCost() }}%</span>
          </div>
          <div class="grid grid-cols-[70px_1fr_36px] gap-2 items-center mb-1.5">
            <label class="text-xs text-slate-700">Overtime</label>
            <input type="range" min="0" max="100" step="1" [(ngModel)]="weightOvertime" />
            <span class="text-xs text-right text-gray-900">{{ activeWeightOvertime() }}%</span>
          </div>
          <div class="text-xs font-semibold uppercase tracking-wider text-slate-700 my-1.5 mt-2">
            Solver caps
          </div>
          <div class="grid grid-cols-[70px_1fr_36px] gap-2 items-center mb-1.5">
            <label class="text-xs text-slate-700">Due cap</label>
            <input type="range" min="0" max="100" step="1" [(ngModel)]="dueCostCapPercent" />
            <span class="text-xs text-right text-gray-900">{{ dueCostCapPercent() }}%</span>
          </div>
          <div class="grid grid-cols-[70px_1fr_36px] gap-2 items-center mb-1.5">
            <label class="text-xs text-slate-700">Detour cap</label>
            <input type="range" min="0" max="100" step="1" [(ngModel)]="detourCostCapPercent" />
            <span class="text-xs text-right text-gray-900">{{ detourCostCapPercent() }}%</span>
          </div>
          <div class="grid grid-cols-[70px_1fr_36px] gap-2 items-center mb-1.5">
            <label class="text-xs text-slate-700">Detour ref</label>
            <input type="range" min="0" max="100" step="1" [(ngModel)]="detourRefKmPercent" />
            <span class="text-xs text-right text-gray-900">{{ detourRefKmPercent() }}%</span>
          </div>
          <div class="grid grid-cols-[70px_1fr_36px] gap-2 items-center mb-1.5">
            <label class="text-xs text-slate-700">Late ref</label>
            <input type="range" min="0" max="100" step="1" [(ngModel)]="lateRefMinutesPercent" />
            <span class="text-xs text-right text-gray-900">{{ lateRefMinutesPercent() }}%</span>
          </div>
          <label class="flex items-center gap-2 text-xs text-slate-700 mt-1.5">
            <input type="checkbox" [(ngModel)]="enforceServiceTypeMatch" />
            <span>Enforce service type match</span>
          </label>
          @if (hasInactiveWeights()) {
            <button
              type="button"
              class="border-none bg-none text-blue-600 text-xs cursor-pointer p-0 mt-1.5 text-left hover:underline"
              (click)="showInactiveWeights.set(!showInactiveWeights())"
            >
              {{ showInactiveWeights() ? 'Hide inactive weights' : 'Show inactive weights' }}
            </button>
          }
        </div>

        @if (!loadingDrivers()) {
          <div class="flex-1 flex flex-col gap-3 items-start mt-4">
            @for (item of driversWithAvailability(); track trackByDriverId($index, item)) {
              <div
                class="w-full px-3.5 py-2.4 bg-gray-50 rounded-md border border-gray-200 transition-all duration-200 relative z-1 select-none"
                [class.bg-blue-50]="isDriverExpanded(item)"
                [class.border-blue-500]="isDriverExpanded(item)"
                [class.border-2]="isDriverExpanded(item)"
                [class.opacity-70]="!item.availability"
                [class.bg-orange-50]="isDriverOverbooked(item) && isDriverExpanded(item)"
                [class.border-orange-500]="isDriverOverbooked(item) && isDriverExpanded(item)"
              >
                <div
                  class="flex items-center justify-between gap-3 cursor-pointer"
                  role="button"
                  tabindex="0"
                  (click)="toggleDriverCard(item, $event)"
                  (keydown.enter)="toggleDriverCard(item, $event)"
                  (keydown.space)="toggleDriverCard(item, $event)"
                >
                  <div class="flex items-center gap-4 flex-wrap pointer-events-none">
                    <span class="text-base font-semibold text-gray-800 flex-1 min-w-max">{{
                      item.driver.name
                    }}</span>
                    <span
                      class="text-sm font-semibold text-blue-600 bg-blue-50 px-2 py-1 rounded whitespace-nowrap"
                      >{{ getDriverHeaderDuration(item) }}</span
                    >
                    <span class="flex items-center text-sm text-gray-500 whitespace-nowrap">
                      <i class="pi pi-clock mr-1"></i>
                      {{ getDriverHeaderTimeRange(item) }}
                    </span>
                  </div>
                  <i
                    class="text-gray-500 text-xs pi"
                    [ngClass]="isDriverExpanded(item) ? 'pi-chevron-down' : 'pi-chevron-right'"
                  ></i>
                </div>
                @if (isDriverExpanded(item)) {
                  <div
                    class="mt-3 pt-3 border-t-2 border-blue-500 bg-blue-50 p-3 rounded-md"
                    (click)="$event.stopPropagation()"
                    (mousedown)="$event.stopPropagation()"
                    (touchstart)="$event.stopPropagation()"
                  >
                    <div class="mb-2">
                      <h4 class="text-sm font-semibold text-blue-900 m-0">
                        <i class="pi pi-map mr-1"></i>
                        Route
                      </h4>
                    </div>
                    <div class="flex items-center gap-3 text-sm text-gray-700 mb-2 flex-wrap">
                      <i class="pi pi-map-marker mr-1"></i>
                      <span
                        >{{
                          getLocationCount(getCurrentRouteForDisplay()!.waypoints)
                        }}
                        location(s)</span
                      >
                      @if (getCurrentRouteForDisplay()!.waypoints.length > 1) {
                        <span class="text-blue-600 font-semibold">
                          <i class="pi pi-clock mr-1"></i>
                          {{ formatRouteTime(getCurrentRouteForDisplay()!.totalTimeMinutes) }}
                          <span style="opacity: 0.75">
                            ({{
                              formatRouteTime(getTotalServiceMinutes(getCurrentRouteForDisplay()!))
                            }}
                            service +
                            {{ formatRouteTime(getDriveMinutes(getCurrentRouteForDisplay()!)) }}
                            driving)
                          </span>
                        </span>
                      }
                      @if (getCurrentRouteForDisplay()!.waypoints.length > 1) {
                        <span class="text-gray-500">
                          <i class="pi pi-map mr-1"></i>
                          @if (isRouteCalculating(getCurrentRouteForDisplay())) {
                            Calculating...
                          } @else {
                            {{ getCurrentRouteForDisplay()!.totalDistanceKm.toFixed(1) }} km
                          }
                        </span>
                      }
                    </div>
                    @if (getCurrentRouteForDisplay()!.waypoints.length > 0) {
                      <div class="flex flex-col gap-1">
                        @if (getStartWaypoint(getCurrentRouteForDisplay()!); as startWp) {
                          <div
                            class="flex items-center gap-2 text-xs px-2 py-1 bg-gray-50 rounded cursor-pointer"
                            (click)="toggleStartOverrideEditor()"
                          >
                            <span class="font-semibold text-gray-500 text-xs uppercase shrink-0"
                              >Start</span
                            >
                            <div class="flex flex-col gap-0 min-w-0 flex-1">
                              <span
                                class="text-gray-700 overflow-hidden text-ellipsis whitespace-nowrap"
                                >{{ startWp.name }}</span
                              >
                              <span
                                class="text-gray-500 text-xs leading-tight whitespace-normal overflow-hidden text-ellipsis block"
                                [title]="
                                  getRouteEndpointCoords(getCurrentRouteForDisplay(), 'start')
                                "
                              >
                                {{ getRouteEndpointAddress(getCurrentRouteForDisplay(), 'start') }}
                              </span>
                            </div>
                            @if (showStartOverrideEditor) {
                              <div class="flex flex-col gap-1.5 w-full mt-1.5">
                                <input
                                  type="text"
                                  class="w-full border border-gray-300 rounded-md p-0.5 text-xs text-gray-700"
                                  placeholder="Start address (optional)"
                                  (click)="$event.stopPropagation()"
                                  [(ngModel)]="startOverrideAddress"
                                />
                                <div class="grid grid-cols-2 gap-1.5">
                                  <input
                                    type="number"
                                    class="w-full border border-gray-300 rounded-md p-0.5 text-xs text-gray-700"
                                    placeholder="Lat"
                                    (click)="$event.stopPropagation()"
                                    [(ngModel)]="startOverrideLatitude"
                                  />
                                  <input
                                    type="number"
                                    class="w-full border border-gray-300 rounded-md p-0.5 text-xs text-gray-700"
                                    placeholder="Lng"
                                    (click)="$event.stopPropagation()"
                                    [(ngModel)]="startOverrideLongitude"
                                  />
                                </div>
                                <div class="flex gap-1.5">
                                  <button
                                    type="button"
                                    class="border border-gray-300 bg-gray-100 text-gray-900 rounded-md px-2 py-0.5 text-xs cursor-pointer"
                                    (click)="$event.stopPropagation(); applyStartOverride()"
                                  >
                                    Apply
                                  </button>
                                  <button
                                    type="button"
                                    class="border border-gray-300 bg-white text-gray-500 rounded-md px-2 py-0.5 text-xs cursor-pointer"
                                    (click)="$event.stopPropagation(); clearStartOverride()"
                                  >
                                    Reset
                                  </button>
                                </div>
                              </div>
                            }
                          </div>
                        }
                        @if (getStopSchedule(getCurrentRouteForDisplay()); as stopSchedule) {
                          <div>
                            @for (
                              waypoint of getLocationWaypoints(getCurrentRouteForDisplay()!);
                              track waypoint;
                              let i = $index
                            ) {
                              <div
                                class="flex items-center gap-2 text-xs px-2 py-1 bg-gray-50 rounded"
                              >
                                <button
                                  type="button"
                                  class="inline-flex items-center justify-center w-4.5 h-4.5 bg-blue-500 text-white rounded-full text-xs font-semibold shrink-0 border-none cursor-pointer"
                                  title="Select stop to reorder"
                                  (click)="$event.stopPropagation(); toggleSelectedRouteStop(i)"
                                >
                                  {{ i + 1 }}
                                </button>
                                @if (selectedRouteStopIndex() === i) {
                                  <div class="inline-flex gap-1 mr-1">
                                    <button
                                      type="button"
                                      class="border border-gray-300 bg-white rounded px-1 py-0.5 cursor-pointer text-gray-700 disabled:opacity-40 disabled:cursor-not-allowed"
                                      title="Move up"
                                      [disabled]="i === 0"
                                      (click)="$event.stopPropagation(); moveSelectedStop('up')"
                                    >
                                      <i class="pi pi-arrow-up"></i>
                                    </button>
                                    <button
                                      type="button"
                                      class="border border-gray-300 bg-white rounded px-1 py-0.5 cursor-pointer text-gray-700 disabled:opacity-40 disabled:cursor-not-allowed"
                                      title="Move down"
                                      [disabled]="
                                        i ===
                                        getLocationWaypoints(getCurrentRouteForDisplay()!).length -
                                          1
                                      "
                                      (click)="$event.stopPropagation(); moveSelectedStop('down')"
                                    >
                                      <i class="pi pi-arrow-down"></i>
                                    </button>
                                  </div>
                                }
                                <div class="flex flex-col gap-0 min-w-0 flex-1">
                                  <span
                                    class="text-gray-700 overflow-hidden text-ellipsis whitespace-nowrap"
                                    >{{ waypoint.name }}</span
                                  >
                                  @if (waypoint.address) {
                                    <span
                                      class="text-gray-500 text-xs leading-tight whitespace-nowrap max-w-full"
                                      [title]="waypoint.address"
                                    >
                                      {{ waypoint.address }}
                                    </span>
                                  }
                                </div>
                                @if (stopSchedule[i]?.label) {
                                  <span class="text-gray-500 text-xs shrink-0">
                                    {{ stopSchedule[i]?.label }}
                                  </span>
                                }
                                @if (!stopSchedule[i]?.label && waypoint.serviceMinutes) {
                                  <span class="text-gray-500 text-xs shrink-0">
                                    ({{ waypoint.serviceMinutes }}m)
                                  </span>
                                }
                              </div>
                            }
                          </div>
                        }
                        @if (getEndWaypoint(getCurrentRouteForDisplay()!); as endWp) {
                          <div
                            class="flex items-center gap-2 text-xs px-2 py-1 bg-gray-50 rounded cursor-pointer"
                            (click)="toggleEndOverrideEditor()"
                          >
                            <span class="font-semibold text-gray-500 text-xs uppercase shrink-0"
                              >End</span
                            >
                            <div class="flex flex-col gap-0 min-w-0 flex-1">
                              <span
                                class="text-gray-700 overflow-hidden text-ellipsis whitespace-nowrap"
                                >{{ endWp.name }}</span
                              >
                              <span
                                class="text-gray-500 text-xs leading-tight whitespace-normal overflow-hidden text-ellipsis block"
                                [title]="getRouteEndpointCoords(getCurrentRouteForDisplay(), 'end')"
                              >
                                {{ getRouteEndpointAddress(getCurrentRouteForDisplay(), 'end') }}
                              </span>
                            </div>
                            @if (showEndOverrideEditor) {
                              <div class="flex flex-col gap-1.5 w-full mt-1.5">
                                <input
                                  type="text"
                                  class="w-full border border-gray-300 rounded-md p-0.5 text-xs text-gray-700"
                                  placeholder="End address (optional)"
                                  (click)="$event.stopPropagation()"
                                  [(ngModel)]="endOverrideAddress"
                                />
                                <div class="grid grid-cols-2 gap-1.5">
                                  <input
                                    type="number"
                                    class="w-full border border-gray-300 rounded-md p-0.5 text-xs text-gray-700"
                                    placeholder="Lat"
                                    (click)="$event.stopPropagation()"
                                    [(ngModel)]="endOverrideLatitude"
                                  />
                                  <input
                                    type="number"
                                    class="w-full border border-gray-300 rounded-md p-0.5 text-xs text-gray-700"
                                    placeholder="Lng"
                                    (click)="$event.stopPropagation()"
                                    [(ngModel)]="endOverrideLongitude"
                                  />
                                </div>
                                <div class="flex gap-1.5">
                                  <button
                                    type="button"
                                    class="border border-gray-300 bg-gray-100 text-gray-900 rounded-md px-2 py-0.5 text-xs cursor-pointer"
                                    (click)="$event.stopPropagation(); applyEndOverride()"
                                  >
                                    Apply
                                  </button>
                                  <button
                                    type="button"
                                    class="border border-gray-300 bg-white text-gray-500 rounded-md px-2 py-0.5 text-xs cursor-pointer"
                                    (click)="$event.stopPropagation(); clearEndOverride()"
                                  >
                                    Reset
                                  </button>
                                </div>
                              </div>
                            }
                          </div>
                        }
                      </div>
                    }
                    @if (
                      isBuildingRoute() &&
                      getCurrentRouteForDisplay()?.driver?.toolId === item.driver.toolId
                    ) {
                      <div class="mt-2">
                        <p-button
                          label="Clear Route"
                          icon="pi pi-times"
                          severity="secondary"
                          size="small"
                          [style]="{ width: '100%', marginTop: '0.5rem' }"
                          (onClick)="clearRoute()"
                        />
                      </div>
                    }
                  </div>
                }
              </div>
            }
            @if (driversWithAvailability().length === 0) {
              <div class="flex items-center justify-center p-8 text-gray-500 text-sm">
                <i class="pi pi-info-circle mr-2"></i>
                No drivers found
              </div>
            }
          </div>
        }

        @if (loadingDrivers()) {
          <div class="flex items-center justify-center p-8 text-gray-500 text-sm">
            <i class="pi pi-spin pi-spinner mr-2"></i>
            Loading drivers...
          </div>
        }
      </div>
    </div>
  </div>
</div>

<p-toast />

<p-dialog
  [modal]="true"
  [closable]="true"
  [style]="{ width: '420px' }"
  [header]="templateDialogMode() === 'update' ? 'Update weight template' : 'Save weight template'"
  [(visible)]="showTemplateNameDialogValue"
>
  <div class="flex flex-col gap-4">
    <div>
      <label class="block text-sm font-semibold mb-1">Template name</label>
      <input pInputText class="w-full" placeholder="Enter a name" [(ngModel)]="newTemplateName" />
    </div>
  </div>
  <ng-template pTemplate="footer">
    <div class="flex justify-end gap-2">
      <p-button
        label="Cancel"
        severity="secondary"
        [outlined]="true"
        (onClick)="showTemplateNameDialog.set(false)"
      />
      <p-button
        label="Save"
        [loading]="templateSaveLoading()"
        (onClick)="saveTemplateFromDialog()"
      />
    </div>
  </ng-template>
</p-dialog>

<p-dialog
  header="Some locations were not added"
  [modal]="true"
  [closable]="true"
  [style]="{ width: '520px' }"
  [(visible)]="showBulkAddDialogValue"
>
  <div class="flex flex-col gap-3">
    <div class="text-xs text-gray-500">These locations were skipped during the bulk add.</div>
    @if (bulkAddRejections().length > 0) {
      <div class="flex flex-col gap-2 max-h-80 overflow-auto">
        @for (item of bulkAddRejections(); track item) {
          <div class="border border-gray-200 rounded-lg p-2 bg-gray-50">
            <div class="text-sm font-semibold text-gray-900">{{ item.name }}</div>
            <div class="text-xs text-amber-600 mt-0.5">{{ item.reason }}</div>
            @if (item.address) {
              <div class="text-xs text-gray-500 mt-0.5 wrap-break-word">{{ item.address }}</div>
            }
          </div>
        }
      </div>
    }
  </div>
  <ng-template pTemplate="footer">
    <div class="flex justify-end">
      <p-button
        label="Close"
        severity="secondary"
        [outlined]="true"
        (onClick)="showBulkAddDialog.set(false)"
      />
    </div>
  </ng-template>
</p-dialog>
