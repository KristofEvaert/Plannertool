<div class="map-page-container">
  <div class="map-page-header">
    <div class="flex items-center gap-2">
      <h1 class="page-title">Service Locations Map</h1>
      <app-help-manual [sectionId]="'map'" />
    </div>

    <div class="controls-section">
      <div class="control-group">
        <label for="serviceType" class="control-label"
          >Service Type <span class="required">*</span></label
        >
        <p-multiSelect
          id="serviceType"
          optionLabel="name"
          optionValue="id"
          placeholder="Select up to 5 service types"
          [options]="serviceTypes()"
          [selectionLimit]="5"
          [showToggleAll]="false"
          [filter]="true"
          [style]="{ width: '100%' }"
          (ngModelChange)="onServiceTypeOrOwnerChange()"
          [(ngModel)]="selectedServiceTypeIds"
        />
      </div>

      <div class="control-group">
        <label for="owner" class="control-label">Owner <span class="required">*</span></label>
        <p-select
          id="owner"
          optionLabel="name"
          optionValue="id"
          placeholder="Select owner"
          [options]="owners()"
          [style]="{ width: '100%' }"
          (ngModelChange)="onServiceTypeOrOwnerChange()"
          [(ngModel)]="selectedOwnerId"
        />
      </div>

      <div class="control-group">
        <label for="fromDate" class="control-label">From Date</label>
        <p-datepicker
          id="fromDate"
          dateFormat="yy-mm-dd"
          [showIcon]="true"
          [style]="{ width: '100%' }"
          [appendTo]="'body'"
          [baseZIndex]="1000"
          (ngModelChange)="onDateRangeChange()"
          [(ngModel)]="fromDate"
        />
      </div>

      <div class="control-group">
        <label for="toDate" class="control-label">To Date</label>
        <p-datepicker
          id="toDate"
          dateFormat="yy-mm-dd"
          [showIcon]="true"
          [style]="{ width: '100%' }"
          [appendTo]="'body'"
          [baseZIndex]="1000"
          (ngModelChange)="onDateRangeChange()"
          [(ngModel)]="toDate"
        />
      </div>

      <div class="control-group button-group">
        <div class="button-row">
          <p-button
            label="Load"
            icon="pi pi-search"
            [loading]="loading()"
            [disabled]="selectedServiceTypeIds().length === 0 || !selectedOwnerId() || loading()"
            (onClick)="onLoad()"
          />
          <p-button
            label="Export schedule"
            icon="pi pi-download"
            severity="secondary"
            [disabled]="loading()"
            (onClick)="exportRoutes()"
          />
        </div>
      </div>
    </div>

    <div class="info-section" *ngIf="mapData()">
      <span class="info-badge">
        <i class="pi pi-map-marker mr-1"></i>
        Total points: {{ mapData()!.totalCount }}
        <span *ngIf="mapData()!.minOrderDate && mapData()!.maxOrderDate">
          ({{ mapData()!.minOrderDate }} to {{ mapData()!.maxOrderDate }})
        </span>
      </span>
    </div>
  </div>

  <div class="map-page-content">
    <div class="map-left-panel">
      <div class="map-toolbar" *ngIf="mapData()">
        <label class="toggle-label">
          <input
            type="checkbox"
            [checked]="showPlannedLocations()"
            (change)="onToggleShowPlannedLocations($event)"
          />
          Show planned locations
        </label>
      </div>

      <div class="map-section">
        <div id="serviceLocationsMap" class="map-element"></div>
      </div>

      <div class="legend-section">
        <div class="legend-urgency">
          <div class="legend-urgency-title">Urgency legend</div>
          <div class="legend-urgency-items">
            <div class="legend-urgency-item" *ngFor="let item of urgencyLegend">
              <span class="legend-swatch" [ngStyle]="getLegendSwatchStyle(item.key)"></span>
              <span class="legend-urgency-label">{{ item.label }}</span>
            </div>
          </div>
        </div>

        <div class="legend-service-types" *ngIf="selectedServiceTypesLegend().length > 0">
          <div class="legend-service-type" *ngFor="let st of selectedServiceTypesLegend()">
            <span class="legend-shape" [ngClass]="getLegendShapeClass(st.id)"></span>
            <span class="legend-service-type-label">{{ st.name }}</span>
          </div>
        </div>
      </div>
    </div>

    <div class="map-right-panel">
      <div class="drivers-section">
        <div class="drivers-section-header">
          <h2 class="drivers-section-title">Available Drivers</h2>
          <p-button
            label="Auto-generate day"
            icon="pi pi-bolt"
            size="small"
            severity="secondary"
            [loading]="autoGenerateLoading()"
            [disabled]="!selectedOwnerId() || !mapData()?.items?.length"
            (onClick)="autoGenerateForAllDrivers()"
          />
          <p-button
            label="Clear day routes"
            icon="pi pi-trash"
            size="small"
            severity="secondary"
            [disabled]="driverRoutes().size === 0"
            (onClick)="clearAllRoutesForDay()"
          />
        </div>

        <div class="date-picker-container">
          <label for="driverDate" class="date-picker-label">Select Date</label>
          <div class="date-picker-row">
            <p-button
              icon="pi pi-angle-left"
              size="small"
              severity="secondary"
              styleClass="date-nav-button"
              (onClick)="shiftSelectedDate(-1)"
            />
            <div class="date-picker-input">
              <p-datepicker
                id="driverDate"
                dateFormat="yy-mm-dd"
                [showIcon]="true"
                [style]="{ width: '100%' }"
                [appendTo]="'body'"
                [baseZIndex]="1000"
                (onSelect)="onDateChange()"
                [(ngModel)]="selectedDate"
              />
            </div>
            <p-button
              icon="pi pi-angle-right"
              size="small"
              severity="secondary"
              styleClass="date-nav-button"
              (onClick)="shiftSelectedDate(1)"
            />
          </div>
        </div>

        <div class="auto-generate-weights">
          <div class="auto-generate-title">Auto-generate weights</div>
          <div class="weight-row">
            <label class="weight-label">Template</label>
            <p-select
              optionLabel="label"
              optionValue="value"
              placeholder="Manual weights"
              styleClass="w-full"
              [options]="weightTemplateOptions()"
              [ngModel]="selectedWeightTemplateId()"
              [showClear]="true"
              [appendTo]="'body'"
              (ngModelChange)="onWeightTemplateChange($event)"
            />
          </div>
          <div class="weight-actions" *ngIf="canManageTemplates()">
            <p-button
              label="Save as new"
              icon="pi pi-save"
              size="small"
              severity="secondary"
              (onClick)="openNewTemplateDialog()"
            />
            <p-button
              label="Update template"
              icon="pi pi-refresh"
              size="small"
              severity="secondary"
              [disabled]="!canUpdateSelectedTemplate()"
              (onClick)="openRenameTemplateDialog()"
            />
          </div>
          <div class="weight-row" *ngIf="weightCost() === 0 || showInactiveWeights()">
            <label class="weight-label">
              Driver Time
              <span class="weight-muted" *ngIf="weightCost() > 0">(suppressed)</span>
            </label>
            <input type="range" min="0" max="100" step="1" [(ngModel)]="weightTime" />
            <span class="weight-value">{{ activeWeightTime() }}%</span>
          </div>
          <div class="weight-row" *ngIf="weightCost() === 0 || showInactiveWeights()">
            <label class="weight-label">
              Distance
              <span class="weight-muted" *ngIf="weightCost() > 0">(suppressed)</span>
            </label>
            <input type="range" min="0" max="100" step="1" [(ngModel)]="weightDistance" />
            <span class="weight-value">{{ activeWeightDistance() }}%</span>
          </div>
          <div class="weight-row">
            <label class="weight-label">Due Date</label>
            <input type="range" min="0" max="100" step="1" [(ngModel)]="weightDate" />
            <span class="weight-value">{{ activeWeightDate() }}%</span>
          </div>
          <div class="weight-row">
            <label class="weight-label">Cost</label>
            <input type="range" min="0" max="100" step="1" [(ngModel)]="weightCost" />
            <span class="weight-value">{{ activeWeightCost() }}%</span>
          </div>
          <div class="weight-row">
            <label class="weight-label">Overtime</label>
            <input type="range" min="0" max="100" step="1" [(ngModel)]="weightOvertime" />
            <span class="weight-value">{{ activeWeightOvertime() }}%</span>
          </div>
          <div class="solver-caps-title">Solver caps</div>
          <div class="weight-row">
            <label class="weight-label">Due cap</label>
            <input type="range" min="0" max="100" step="1" [(ngModel)]="dueCostCapPercent" />
            <span class="weight-value">{{ dueCostCapPercent() }}%</span>
          </div>
          <div class="weight-row">
            <label class="weight-label">Detour cap</label>
            <input type="range" min="0" max="100" step="1" [(ngModel)]="detourCostCapPercent" />
            <span class="weight-value">{{ detourCostCapPercent() }}%</span>
          </div>
          <div class="weight-row">
            <label class="weight-label">Detour ref</label>
            <input type="range" min="0" max="100" step="1" [(ngModel)]="detourRefKmPercent" />
            <span class="weight-value">{{ detourRefKmPercent() }}%</span>
          </div>
          <div class="weight-row">
            <label class="weight-label">Late ref</label>
            <input type="range" min="0" max="100" step="1" [(ngModel)]="lateRefMinutesPercent" />
            <span class="weight-value">{{ lateRefMinutesPercent() }}%</span>
          </div>
          <label class="weight-checkbox">
            <input type="checkbox" [(ngModel)]="enforceServiceTypeMatch" />
            <span>Enforce service type match</span>
          </label>
          <button
            type="button"
            class="weight-toggle"
            *ngIf="hasInactiveWeights()"
            (click)="showInactiveWeights.set(!showInactiveWeights())"
          >
            {{ showInactiveWeights() ? 'Hide inactive weights' : 'Show inactive weights' }}
          </button>
        </div>

        <div class="drivers-list" *ngIf="!loadingDrivers()">
          <div
            class="driver-item"
            *ngFor="let item of driversWithAvailability(); trackBy: trackByDriverId"
            [class.driver-item-selected]="isDriverExpanded(item)"
            [class.driver-item-unavailable]="!item.availability"
            [class.driver-item-overbooked]="isDriverOverbooked(item)"
            [class.driver-item-selected.driver-item-overbooked]="
              isDriverOverbooked(item) && isDriverExpanded(item)
            "
          >
            <div
              class="driver-header"
              role="button"
              tabindex="0"
              (click)="toggleDriverCard(item, $event)"
              (keydown.enter)="toggleDriverCard(item, $event)"
              (keydown.space)="toggleDriverCard(item, $event)"
            >
              <div class="driver-content">
                <span class="driver-name">{{ item.driver.name }}</span>
                <span class="driver-hours">{{ getDriverHeaderDuration(item) }}</span>
                <span class="driver-availability">
                  <i class="pi pi-clock mr-1"></i>
                  {{ getDriverHeaderTimeRange(item) }}
                </span>
              </div>
              <i
                class="driver-toggle-icon pi"
                [ngClass]="isDriverExpanded(item) ? 'pi-chevron-down' : 'pi-chevron-right'"
              ></i>
            </div>
            <div
              class="driver-route-info"
              *ngIf="isDriverExpanded(item)"
              (click)="$event.stopPropagation()"
              (mousedown)="$event.stopPropagation()"
              (touchstart)="$event.stopPropagation()"
            >
              <div class="route-header">
                <h4 class="route-title">
                  <i class="pi pi-map mr-1"></i>
                  Route
                </h4>
              </div>
              <div class="route-summary">
                <i class="pi pi-map-marker mr-1"></i>
                <span
                  >{{ getLocationCount(getCurrentRouteForDisplay()!.waypoints) }} location(s)</span
                >
                <span class="route-time" *ngIf="getCurrentRouteForDisplay()!.waypoints.length > 1">
                  <i class="pi pi-clock mr-1"></i>
                  {{ formatRouteTime(getCurrentRouteForDisplay()!.totalTimeMinutes) }}
                  <span style="opacity: 0.75">
                    ({{ formatRouteTime(getTotalServiceMinutes(getCurrentRouteForDisplay()!)) }}
                    service +
                    {{ formatRouteTime(getDriveMinutes(getCurrentRouteForDisplay()!)) }} driving)
                  </span>
                </span>
                <span
                  class="route-distance"
                  *ngIf="getCurrentRouteForDisplay()!.waypoints.length > 1"
                >
                  <i class="pi pi-map mr-1"></i>
                  <ng-container
                    *ngIf="isRouteCalculating(getCurrentRouteForDisplay()); else showKm"
                  >
                    Calculating...
                  </ng-container>
                  <ng-template #showKm>
                    {{ getCurrentRouteForDisplay()!.totalDistanceKm.toFixed(1) }} km
                  </ng-template>
                </span>
              </div>
              <div
                class="route-locations"
                *ngIf="getCurrentRouteForDisplay()!.waypoints.length > 0"
              >
                <div
                  class="route-location-item route-start route-location-clickable"
                  *ngIf="getStartWaypoint(getCurrentRouteForDisplay()!) as startWp"
                  (click)="toggleStartOverrideEditor()"
                >
                  <span class="route-location-label">Start</span>
                  <span class="route-location-name">{{ startWp.name }}</span>
                  <span
                    class="route-location-address"
                    [title]="getRouteEndpointCoords(getCurrentRouteForDisplay(), 'start')"
                  >
                    {{ getRouteEndpointAddress(getCurrentRouteForDisplay(), 'start') }}
                  </span>
                  <div class="route-override-editor" *ngIf="showStartOverrideEditor">
                    <input
                      type="text"
                      class="route-override-input"
                      placeholder="Start address (optional)"
                      (click)="$event.stopPropagation()"
                      [(ngModel)]="startOverrideAddress"
                    />
                    <div class="route-override-coords">
                      <input
                        type="number"
                        class="route-override-input"
                        placeholder="Lat"
                        (click)="$event.stopPropagation()"
                        [(ngModel)]="startOverrideLatitude"
                      />
                      <input
                        type="number"
                        class="route-override-input"
                        placeholder="Lng"
                        (click)="$event.stopPropagation()"
                        [(ngModel)]="startOverrideLongitude"
                      />
                    </div>
                    <div class="route-override-actions">
                      <button
                        type="button"
                        class="route-override-btn"
                        (click)="$event.stopPropagation(); applyStartOverride()"
                      >
                        Apply
                      </button>
                      <button
                        type="button"
                        class="route-override-btn secondary"
                        (click)="$event.stopPropagation(); clearStartOverride()"
                      >
                        Reset
                      </button>
                    </div>
                  </div>
                </div>

                <div *ngIf="getStopSchedule(getCurrentRouteForDisplay()) as stopSchedule">
                  <div
                    class="route-location-item"
                    *ngFor="
                      let waypoint of getLocationWaypoints(getCurrentRouteForDisplay()!);
                      let i = index
                    "
                  >
                    <button
                      type="button"
                      class="route-location-number route-location-number-btn"
                      title="Select stop to reorder"
                      (click)="$event.stopPropagation(); toggleSelectedRouteStop(i)"
                    >
                      {{ i + 1 }}
                    </button>

                    <div class="route-reorder-controls" *ngIf="selectedRouteStopIndex() === i">
                      <button
                        type="button"
                        class="route-reorder-btn"
                        title="Move up"
                        [disabled]="i === 0"
                        (click)="$event.stopPropagation(); moveSelectedStop('up')"
                      >
                        <i class="pi pi-arrow-up"></i>
                      </button>
                      <button
                        type="button"
                        class="route-reorder-btn"
                        title="Move down"
                        [disabled]="
                          i === getLocationWaypoints(getCurrentRouteForDisplay()!).length - 1
                        "
                        (click)="$event.stopPropagation(); moveSelectedStop('down')"
                      >
                        <i class="pi pi-arrow-down"></i>
                      </button>
                    </div>

                    <div class="route-location-main">
                      <span class="route-location-name">{{ waypoint.name }}</span>
                      <span
                        class="route-location-address route-location-address-compact"
                        *ngIf="waypoint.address"
                        [title]="waypoint.address"
                      >
                        {{ waypoint.address }}
                      </span>
                    </div>
                    <span class="route-location-time" *ngIf="stopSchedule[i]?.label">
                      {{ stopSchedule[i]?.label }}
                    </span>
                    <span
                      class="route-location-time"
                      *ngIf="!stopSchedule[i]?.label && waypoint.serviceMinutes"
                    >
                      ({{ waypoint.serviceMinutes }}m)
                    </span>
                  </div>
                </div>

                <div
                  class="route-location-item route-end route-location-clickable"
                  *ngIf="getEndWaypoint(getCurrentRouteForDisplay()!) as endWp"
                  (click)="toggleEndOverrideEditor()"
                >
                  <span class="route-location-label">End</span>
                  <span class="route-location-name">{{ endWp.name }}</span>
                  <span
                    class="route-location-address"
                    [title]="getRouteEndpointCoords(getCurrentRouteForDisplay(), 'end')"
                  >
                    {{ getRouteEndpointAddress(getCurrentRouteForDisplay(), 'end') }}
                  </span>
                  <div class="route-override-editor" *ngIf="showEndOverrideEditor">
                    <input
                      type="text"
                      class="route-override-input"
                      placeholder="End address (optional)"
                      (click)="$event.stopPropagation()"
                      [(ngModel)]="endOverrideAddress"
                    />
                    <div class="route-override-coords">
                      <input
                        type="number"
                        class="route-override-input"
                        placeholder="Lat"
                        (click)="$event.stopPropagation()"
                        [(ngModel)]="endOverrideLatitude"
                      />
                      <input
                        type="number"
                        class="route-override-input"
                        placeholder="Lng"
                        (click)="$event.stopPropagation()"
                        [(ngModel)]="endOverrideLongitude"
                      />
                    </div>
                    <div class="route-override-actions">
                      <button
                        type="button"
                        class="route-override-btn"
                        (click)="$event.stopPropagation(); applyEndOverride()"
                      >
                        Apply
                      </button>
                      <button
                        type="button"
                        class="route-override-btn secondary"
                        (click)="$event.stopPropagation(); clearEndOverride()"
                      >
                        Reset
                      </button>
                    </div>
                  </div>
                </div>
              </div>
              <div
                class="route-actions"
                *ngIf="
                  isBuildingRoute() &&
                  getCurrentRouteForDisplay()?.driver?.toolId === item.driver.toolId
                "
              >
                <p-button
                  label="Clear Route"
                  icon="pi pi-times"
                  severity="secondary"
                  size="small"
                  [style]="{ width: '100%', marginTop: '0.5rem' }"
                  (onClick)="clearRoute()"
                />
              </div>
            </div>
          </div>

          <div class="no-drivers" *ngIf="driversWithAvailability().length === 0">
            <i class="pi pi-info-circle mr-2"></i>
            No drivers found
          </div>
        </div>

        <div class="drivers-loading" *ngIf="loadingDrivers()">
          <i class="pi pi-spin pi-spinner mr-2"></i>
          Loading drivers...
        </div>
      </div>
    </div>
  </div>
</div>

<p-toast />

<p-dialog
  [modal]="true"
  [closable]="true"
  [style]="{ width: '420px' }"
  [header]="templateDialogMode() === 'update' ? 'Update weight template' : 'Save weight template'"
  [(visible)]="showTemplateNameDialogValue"
>
  <div class="flex flex-col gap-4">
    <div>
      <label class="block text-sm font-semibold mb-1">Template name</label>
      <input pInputText class="w-full" placeholder="Enter a name" [(ngModel)]="newTemplateName" />
    </div>
  </div>
  <ng-template pTemplate="footer">
    <div class="flex justify-end gap-2">
      <p-button
        label="Cancel"
        severity="secondary"
        [outlined]="true"
        (onClick)="showTemplateNameDialog.set(false)"
      />
      <p-button
        label="Save"
        [loading]="templateSaveLoading()"
        (onClick)="saveTemplateFromDialog()"
      />
    </div>
  </ng-template>
</p-dialog>

<p-dialog
  header="Some locations were not added"
  [modal]="true"
  [closable]="true"
  [style]="{ width: '520px' }"
  [(visible)]="showBulkAddDialogValue"
>
  <div class="bulk-add-dialog">
    <div class="bulk-add-subtitle">These locations were skipped during the bulk add.</div>
    <div class="bulk-add-list" *ngIf="bulkAddRejections().length > 0">
      <div class="bulk-add-item" *ngFor="let item of bulkAddRejections()">
        <div class="bulk-add-name">{{ item.name }}</div>
        <div class="bulk-add-reason">{{ item.reason }}</div>
        <div class="bulk-add-address" *ngIf="item.address">{{ item.address }}</div>
      </div>
    </div>
  </div>
  <ng-template pTemplate="footer">
    <div class="flex justify-end">
      <p-button
        label="Close"
        severity="secondary"
        [outlined]="true"
        (onClick)="showBulkAddDialog.set(false)"
      />
    </div>
  </ng-template>
</p-dialog>
