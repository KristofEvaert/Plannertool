<p-toast />
<div class="pt-20 px-6 pb-6">
  <div class="max-w-7xl mx-auto space-y-4">
    <div class="flex items-center justify-between gap-4 flex-wrap">
      <div class="flex items-center gap-2">
        <h1 class="text-2xl font-bold text-gray-900">Travel Time Model (Admin)</h1>
        <app-help-manual [sectionId]="'travel-time-model'" />
        <span class="text-xs text-gray-500">SuperAdmin only</span>
      </div>
      <p-button label="Refresh" icon="pi pi-refresh" [loading]="loading()" (onClick)="load()" />
    </div>

    <div class="card p-3">
      <div class="filters">
        <div class="filter">
          <label class="block text-sm font-semibold mb-1">Region</label>
          <p-select
            optionLabel="label"
            optionValue="value"
            placeholder="All regions"
            [options]="regionOptions()"
            [ngModel]="selectedRegionId()"
            [showClear]="true"
            [filter]="true"
            (ngModelChange)="selectedRegionId.set($event)"
          />
        </div>
        <div class="filter">
          <label class="block text-sm font-semibold mb-1">Status</label>
          <p-select
            optionLabel="label"
            optionValue="value"
            placeholder="All statuses"
            [options]="statusOptions()"
            [ngModel]="selectedStatus()"
            [showClear]="true"
            (ngModelChange)="selectedStatus.set($event)"
          />
        </div>
        <div class="filter">
          <label class="block text-sm font-semibold mb-1">Day type</label>
          <p-select
            optionLabel="label"
            optionValue="value"
            placeholder="All day types"
            [options]="dayTypeOptions()"
            [ngModel]="selectedDayType()"
            [showClear]="true"
            (ngModelChange)="selectedDayType.set($event)"
          />
        </div>
        <div class="filter">
          <label class="block text-sm font-semibold mb-1">Distance band</label>
          <p-select
            optionLabel="label"
            optionValue="value"
            placeholder="All bands"
            [options]="distanceBandOptions()"
            [ngModel]="selectedDistanceBand()"
            [showClear]="true"
            (ngModelChange)="selectedDistanceBand.set($event)"
          />
        </div>
        <div class="filter flagged-only">
          <p-checkbox
            inputId="flagged-only"
            [binary]="true"
            [ngModel]="showFlaggedOnly()"
            (ngModelChange)="showFlaggedOnly.set($event)"
          />
          <label for="flagged-only" class="text-sm font-semibold">Show flagged only</label>
        </div>
      </div>
    </div>

    <div class="card p-3">
      @if (loading()) {
        <div class="text-sm text-gray-500">Loading learned stats...</div>
      }
      @if (!loading() && !filteredRows().length) {
        <div class="text-sm text-gray-500">No learned stats match the current filters.</div>
      }
      @if (filteredRows().length) {
        <div class="travel-cards">
          @for (row of filteredRows(); track row.id) {
            <div class="tt-card">
              <div class="tt-card-header">
                <div class="tt-card-main">
                  <div class="tt-title">
                    <span class="tt-region">{{ row.regionName }}</span>
                    <span class="tt-divider">|</span>
                    <span>{{ row.dayType }}</span>
                  </div>
                  <div class="tt-sub">
                    <span>Bucket {{ formatBucket(row) }}</span>
                    <span class="tt-divider">|</span>
                    <span>Band {{ formatDistanceBand(row) }}</span>
                  </div>
                </div>
                <div class="tt-card-meta">
                  <p-tag [value]="row.status" [severity]="statusSeverity(row.status)" />
                  <div class="flags">
                    @if (row.isOutOfRange) {
                      <i
                        class="pi pi-exclamation-circle text-red-600"
                        pTooltip="Out of plausible range"
                      ></i>
                    }
                    @if (row.isStale) {
                      <i class="pi pi-clock text-orange-600" pTooltip="Stale"></i>
                    }
                    @if (row.isLowSample) {
                      <i class="pi pi-database text-yellow-600" pTooltip="Low sample count"></i>
                    }
                    @if (row.isHighDeviation) {
                      <i
                        class="pi pi-chart-line text-purple-600"
                        pTooltip="High deviation vs baseline"
                      ></i>
                    }
                    @if (row.suspiciousRatio > 0) {
                      <span class="text-xs text-gray-600" pTooltip="Suspicious ratio">
                        S {{ formatRatio(row) }}
                      </span>
                    }
                  </div>
                </div>
              </div>

              <div class="tt-stats">
                <div class="tt-stat">
                  <span class="tt-label">Samples</span>
                  <span class="tt-value">{{ row.totalSampleCount }}</span>
                </div>
                <div class="tt-stat">
                  <span class="tt-label">Avg min/km</span>
                  <span class="tt-value">
                    {{ row.avgMinutesPerKm !== null ? (row.avgMinutesPerKm | number: '1.2-2') : 'ƒ?"' }}
                  </span>
                </div>
                <div class="tt-stat">
                  <span class="tt-label">Min/Max</span>
                  <span class="tt-value">
                    {{ row.minMinutesPerKm !== null ? (row.minMinutesPerKm | number: '1.2-2') : 'ƒ?"' }} /
                    {{ row.maxMinutesPerKm !== null ? (row.maxMinutesPerKm | number: '1.2-2') : 'ƒ?"' }}
                  </span>
                </div>
                <div class="tt-stat">
                  <span class="tt-label">Baseline</span>
                  <span class="tt-value">{{ row.baselineMinutesPerKm | number: '1.2-2' }}</span>
                </div>
                <div class="tt-stat">
                  <span class="tt-label">Expected</span>
                  <span class="tt-value">
                    {{ row.expectedRangeMin | number: '1.2-2' }} - {{ row.expectedRangeMax | number: '1.2-2' }}
                  </span>
                </div>
                <div class="tt-stat">
                  <span class="tt-label">Deviation</span>
                  <span class="tt-value">{{ formatDeviation(row) }}</span>
                </div>
                <div class="tt-stat">
                  <span class="tt-label">Last sample</span>
                  <span class="tt-value">
                    {{ row.lastSampleAtUtc ? (row.lastSampleAtUtc | date: 'yyyy-MM-dd HH:mm') : 'ƒ?"' }}
                  </span>
                </div>
              </div>

              <div class="tt-card-footer">
                <div class="actions">
                  <p-button
                    label="Approve"
                    size="small"
                    [disabled]="row.status === 'Approved'"
                    (onClick)="applyStatus(row, 'Approved')"
                  />
                  <p-button
                    label="Quarantine"
                    size="small"
                    severity="warn"
                    [outlined]="true"
                    (onClick)="applyStatus(row, 'Quarantined')"
                  />
                  <p-button
                    label="Reject"
                    size="small"
                    severity="danger"
                    [outlined]="true"
                    (onClick)="applyStatus(row, 'Rejected')"
                  />
                  <p-button
                    label="Reset"
                    size="small"
                    severity="secondary"
                    [outlined]="true"
                    (onClick)="resetBucket(row)"
                  />
                </div>
                <p-button
                  class="tt-expand"
                  size="small"
                  [outlined]="true"
                  [icon]="isRowExpanded(row) ? 'pi pi-chevron-up' : 'pi pi-chevron-down'"
                  [label]="'Contributors (' + (row.contributors.length || 0) + ')'"
                  (onClick)="toggleRow(row)"
                />
              </div>

              @if (isRowExpanded(row)) {
                <div class="tt-expand-panel">
                  <div class="tt-expand-header">
                    <span class="font-semibold">Contributing drivers</span>
                    <span class="text-xs text-gray-500">Top contributors</span>
                  </div>
                  @if (!row.contributors.length) {
                    <div class="text-sm text-gray-500">No contributors recorded yet.</div>
                  }
                  @if (row.contributors.length) {
                    <div class="tt-contrib-list">
                      @for (contrib of row.contributors; track contrib.driverId) {
                        <div class="tt-contrib-row">
                          <div class="tt-contrib-name">
                            {{ contrib.driverName || 'Driver #' + contrib.driverId }}
                          </div>
                          <div class="tt-contrib-meta">
                            <span class="tt-label">Samples</span>
                            <span class="tt-value">{{ contrib.sampleCount }}</span>
                          </div>
                          <div class="tt-contrib-meta">
                            <span class="tt-label">Last</span>
                            <span class="tt-value">
                              {{
                                contrib.lastContributionUtc
                                  ? (contrib.lastContributionUtc | date: 'yyyy-MM-dd HH:mm')
                                  : 'ƒ?"'
                              }}
                            </span>
                          </div>
                        </div>
                      }
                    </div>
                  }
                </div>
              }
            </div>
          }
        </div>
      }
    </div>
  </div>
</div>
