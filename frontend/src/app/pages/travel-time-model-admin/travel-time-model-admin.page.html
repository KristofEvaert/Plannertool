<p-toast />
<div class="pt-20 px-6 pb-6">
  <div class="max-w-7xl mx-auto space-y-4">
    <div class="flex items-center justify-between gap-4 flex-wrap">
      <div class="flex items-center gap-2">
        <h1 class="text-2xl font-bold text-gray-900">Travel Time Model (Admin)</h1>
        <app-help-manual [sectionId]="'travel-time-model'" />
        <span class="text-xs text-gray-500">SuperAdmin only</span>
      </div>
      <p-button label="Refresh" icon="pi pi-refresh" [loading]="loading()" (onClick)="load()" />
    </div>

    <div class="card p-3">
      <div class="filters">
        <div class="filter">
          <label class="block text-sm font-semibold mb-1">Region</label>
          <p-select
            optionLabel="label"
            optionValue="value"
            placeholder="All regions"
            [options]="regionOptions()"
            [ngModel]="selectedRegionId()"
            [showClear]="true"
            [filter]="true"
            (ngModelChange)="selectedRegionId.set($event)"
          />
        </div>
        <div class="filter">
          <label class="block text-sm font-semibold mb-1">Status</label>
          <p-select
            optionLabel="label"
            optionValue="value"
            placeholder="All statuses"
            [options]="statusOptions()"
            [ngModel]="selectedStatus()"
            [showClear]="true"
            (ngModelChange)="selectedStatus.set($event)"
          />
        </div>
        <div class="filter">
          <label class="block text-sm font-semibold mb-1">Day type</label>
          <p-select
            optionLabel="label"
            optionValue="value"
            placeholder="All day types"
            [options]="dayTypeOptions()"
            [ngModel]="selectedDayType()"
            [showClear]="true"
            (ngModelChange)="selectedDayType.set($event)"
          />
        </div>
        <div class="filter">
          <label class="block text-sm font-semibold mb-1">Distance band</label>
          <p-select
            optionLabel="label"
            optionValue="value"
            placeholder="All bands"
            [options]="distanceBandOptions()"
            [ngModel]="selectedDistanceBand()"
            [showClear]="true"
            (ngModelChange)="selectedDistanceBand.set($event)"
          />
        </div>
        <div class="filter flagged-only">
          <p-checkbox
            inputId="flagged-only"
            [binary]="true"
            [ngModel]="showFlaggedOnly()"
            (ngModelChange)="showFlaggedOnly.set($event)"
          />
          <label for="flagged-only" class="text-sm font-semibold">Show flagged only</label>
        </div>
      </div>
    </div>

    <div class="card p-3">
      <p-table
        dataKey="id"
        [value]="filteredRows()"
        [loading]="loading()"
        [expandedRowKeys]="expandedRows()"
        (onRowExpand)="onRowExpand($event)"
        (onRowCollapse)="onRowCollapse($event)"
      >
        <ng-template pTemplate="header">
          <tr>
            <th class="w-8"></th>
            <th>Region</th>
            <th>Day</th>
            <th>Bucket</th>
            <th>Band</th>
            <th>Status</th>
            <th>Samples</th>
            <th>Avg</th>
            <th>Min/Max</th>
            <th>Baseline</th>
            <th>Expected</th>
            <th>Deviation</th>
            <th>Last Sample</th>
            <th>Flags</th>
            <th class="text-right">Actions</th>
          </tr>
        </ng-template>
        <ng-template let-row let-expanded="expanded" pTemplate="body">
          <tr>
            <td>
              <p-button
                pButton
                pRowToggler
                class="p-button-text p-button-sm"
                [pRowToggler]="row"
                [icon]="expanded ? 'pi pi-chevron-down' : 'pi pi-chevron-right'"
              />
            </td>
            <td class="font-medium">{{ row.regionName }}</td>
            <td>{{ row.dayType }}</td>
            <td>{{ formatBucket(row) }}</td>
            <td>{{ formatDistanceBand(row) }}</td>
            <td><p-tag [value]="row.status" [severity]="statusSeverity(row.status)" /></td>
            <td>{{ row.totalSampleCount }}</td>
            <td>
              {{ row.avgMinutesPerKm !== null ? (row.avgMinutesPerKm | number: '1.2-2') : '—' }}
            </td>
            <td>
              {{ row.minMinutesPerKm !== null ? (row.minMinutesPerKm | number: '1.2-2') : '—' }} /
              {{ row.maxMinutesPerKm !== null ? (row.maxMinutesPerKm | number: '1.2-2') : '—' }}
            </td>
            <td>{{ row.baselineMinutesPerKm | number: '1.2-2' }}</td>
            <td>
              {{ row.expectedRangeMin | number: '1.2-2' }} -
              {{ row.expectedRangeMax | number: '1.2-2' }}
            </td>
            <td>{{ formatDeviation(row) }}</td>
            <td>
              {{ row.lastSampleAtUtc ? (row.lastSampleAtUtc | date: 'yyyy-MM-dd HH:mm') : '—' }}
            </td>
            <td>
              <div class="flags">
                @if (row.isOutOfRange) {
                  <i
                    class="pi pi-exclamation-circle text-red-600"
                    pTooltip="Out of plausible range"
                  ></i>
                }
                @if (row.isStale) {
                  <i class="pi pi-clock text-orange-600" pTooltip="Stale"></i>
                }
                @if (row.isLowSample) {
                  <i class="pi pi-database text-yellow-600" pTooltip="Low sample count"></i>
                }
                @if (row.isHighDeviation) {
                  <i
                    class="pi pi-chart-line text-purple-600"
                    pTooltip="High deviation vs baseline"
                  ></i>
                }
                @if (row.suspiciousRatio > 0) {
                  <span class="text-xs text-gray-600" pTooltip="Suspicious ratio">
                    S {{ formatRatio(row) }}
                  </span>
                }
              </div>
            </td>
            <td class="text-right">
              <div class="actions">
                <p-button
                  label="Approve"
                  size="small"
                  [disabled]="row.status === 'Approved'"
                  (onClick)="applyStatus(row, 'Approved')"
                />
                <p-button
                  label="Quarantine"
                  size="small"
                  severity="warn"
                  [outlined]="true"
                  (onClick)="applyStatus(row, 'Quarantined')"
                />
                <p-button
                  label="Reject"
                  size="small"
                  severity="danger"
                  [outlined]="true"
                  (onClick)="applyStatus(row, 'Rejected')"
                />
                <p-button
                  label="Reset"
                  size="small"
                  severity="secondary"
                  [outlined]="true"
                  (onClick)="resetBucket(row)"
                />
              </div>
            </td>
          </tr>
        </ng-template>
        <ng-template let-row pTemplate="rowexpansion">
          <tr>
            <td colspan="15">
              <div class="expansion">
                <div class="expansion-header">
                  <span class="font-semibold">Contributing Drivers</span>
                  <span class="text-xs text-gray-500">Top contributors</span>
                </div>
                @if (!row.contributors?.length) {
                  <div class="text-sm text-gray-500">No contributors recorded yet.</div>
                }
                @if (row.contributors?.length) {
                  <p-table [value]="row.contributors">
                    <ng-template pTemplate="header">
                      <tr>
                        <th>Driver</th>
                        <th>Samples</th>
                        <th>Last Contribution</th>
                      </tr>
                    </ng-template>
                    <ng-template let-contrib pTemplate="body">
                      <tr>
                        <td>{{ contrib.driverName || 'Driver #' + contrib.driverId }}</td>
                        <td>{{ contrib.sampleCount }}</td>
                        <td>
                          {{
                            contrib.lastContributionUtc
                              ? (contrib.lastContributionUtc | date: 'yyyy-MM-dd HH:mm')
                              : '—'
                          }}
                        </td>
                      </tr>
                    </ng-template>
                  </p-table>
                }
              </div>
            </td>
          </tr>
        </ng-template>
      </p-table>
    </div>
  </div>
</div>
