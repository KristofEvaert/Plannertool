<div class="container mx-auto p-6">
  <!-- Header -->
  <div class="mb-6">
    <div class="flex items-center justify-between mb-4">
      <div class="flex items-center gap-2">
        <h1 class="text-3xl font-bold text-gray-900">Driver Availability</h1>
        <app-help-manual [sectionId]="'drivers'" />
      </div>
      <div class="flex items-center gap-2">
        <p-button
          label="Download Availability Template"
          icon="pi pi-download"
          [outlined]="true"
          (onClick)="downloadTemplate()"
        />
        <p-button
          label="Download Service Types Template"
          icon="pi pi-download"
          [outlined]="true"
          (onClick)="downloadServiceTypesTemplate()"
        />
        <p-button
          label="Bulk Upload"
          icon="pi pi-file-excel"
          [outlined]="true"
          (onClick)="menu.toggle($event)"
          (focus)="excelUpload.show($event)"
          (blur)="excelUpload.hide()"
          (mouseover)="excelUpload.show($event)"
          (mouseleave)="excelUpload.hide()"
        />
        <p-menu #menu appendTo="body" [model]="bulkMenuItems" [popup]="true" />
        <input
          #fileInput
          type="file"
          accept=".xlsx,.xls"
          style="display: none"
          (change)="onFileSelected($event)"
        />
        <p-popover #excelUpload>
          <div class="text-sm font-semibold mb-2">Excel upload</div>
          <div class="text-xs text-gray-500 max-w-100">
            Use the template. The system reads dates from the header until the first empty date, and
            rows until the first empty email. <br />
            Availability cells use "start;end" minutes (e.g. 480;960). <br />
            Empty cells clear availability for that date.
          </div>
        </p-popover>
      </div>
    </div>
    <div class="flex items-center justify-start mb-4 gap-4">
      <div class="flex items-center justify-between gap-2">
        <label class="text-sm font-medium">Owner</label>
        <p-select
          optionLabel="name"
          optionValue="id"
          placeholder="All owners"
          class="w-56"
          [options]="owners()"
          [showClear]="true"
          [(ngModel)]="ownerFilterId"
        />
      </div>

      <label class="flex items-center gap-2 text-sm text-gray-700">
        <input type="checkbox" [(ngModel)]="showOnlyDriversWithAvailability" />
        <span>Only drivers with availability</span>
      </label>

      <div class="flex items-center justify-between gap-2">
        <label class="text-sm font-medium">Start date</label>
        <p-datepicker [dateFormat]="'yy-mm-dd'" [showIcon]="true" [(ngModel)]="startDate" />
      </div>

      <div class="flex items-center justify-between gap-2">
        <label class="text-sm font-medium">Range</label>
        <p-select
          optionLabel="label"
          optionValue="value"
          [options]="rangeOptions"
          (onChange)="onRangeChange()"
          [(ngModel)]="visibleDays"
        />
      </div>
      <div class="flex items-center justify-end gap-2 ml-auto">
        <p-button label="Prev" icon="pi pi-chevron-left" [text]="true" (onClick)="goToPrev()" />
        <p-button label="Today" icon="pi pi-calendar" [text]="true" (onClick)="goToToday()" />
        <p-button
          label="Next"
          icon="pi pi-chevron-right"
          iconPos="right"
          [text]="true"
          (onClick)="goToNext()"
        />
      </div>
    </div>

    <div class="text-sm text-right text-gray-600">
      Showing: {{ availableDrivers().length }} drivers | {{ formatDateFull(startDate()) }} ->
      {{ formatDateFull(endDate()) }}
    </div>
  </div>

  <!-- Grid -->
  @if (loading()) {
    <div class="text-center py-8">Loading...</div>
  } @else {
    <div class="border border-gray-300 rounded-lg overflow-auto max-h-[calc(100vh-250px)]">
      <div class="grid pb-8" [style.grid-template-columns]="gridTemplateColumns()">
        <!-- Top-left corner (empty) -->
        <div
          class="sticky top-0 left-0 z-20 bg-gray-100 border-r border-b border-gray-300 p-2 font-semibold select-none"
        >
          Driver
          <div
            class="absolute top-0 right-0 h-full w-1 cursor-col-resize"
            (mousedown)="onDriverColumnResizeStart($event)"
          ></div>
        </div>

        <!-- Day headers (sticky top) -->
        @for (date of dateRange(); track dateToYmd(date)) {
          <div
            class="sticky top-0 z-10 bg-gray-100 border-r border-b border-gray-300 p-2 text-center font-semibold text-sm"
          >
            <div>{{ formatDateHeader(date) }}</div>
            <div class="text-xs text-gray-500">{{ date.getDate() }}/{{ date.getMonth() + 1 }}</div>
          </div>
        }

        <!-- Driver rows -->
        @for (driver of availableDrivers(); track driver.toolId) {
          <!-- Driver name (sticky left) -->
          <div
            class="sticky left-0 z-10 bg-white border-r border-b border-gray-300 p-2 font-medium"
            [class.bg-gray-50]="$even"
          >
            <div class="flex items-center justify-between gap-2">
              <div class="min-w-0">
                <div
                  pTooltip="{{ getServiceTypeTooltip(driver) }}"
                  class="truncate"
                  tooltipPosition="top"
                >
                  {{ driver.name }}
                </div>
                <div class="text-xs text-gray-500 truncate">ERP: {{ driver.erpId }}</div>
                @if (driver.ownerName) {
                  <div class="text-xs text-gray-500 truncate">Owner: {{ driver.ownerName }}</div>
                }
              </div>
              <div class="flex gap-1">
                <p-button
                  icon="pi pi-pencil"
                  severity="secondary"
                  size="small"
                  styleClass="driver-action-icon-btn"
                  [style]="{ padding: '0.25rem' }"
                  (onClick)="openEditDriverDialog(driver)"
                />
                <p-button
                  icon="pi pi-trash"
                  severity="danger"
                  size="small"
                  [style]="{
                    'background-color': '#dc2626',
                    'border-color': '#dc2626',
                    color: 'white',
                    padding: '0.25rem',
                  }"
                  (onClick)="deleteDriver(driver)"
                />
              </div>
            </div>
          </div>

          <!-- Availability cells -->
          @for (date of dateRange(); track dateToYmd(date)) {
            @if (getAvailabilityForCell(driver, date); as availability) {
              <div
                class="border-r border-b border-gray-200 p-1 min-h-[56px] cursor-pointer hover:bg-gray-50 transition-colors"
                [class.bg-gray-50]="$even"
                (click)="onCellClick({ driver, date, availability })"
              >
                <div class="bg-blue-500 text-white rounded px-2 py-1 text-xs shadow-sm">
                  <div class="font-medium">
                    {{ minutesToHHmm(availability.startMinuteOfDay) }}-{{
                      minutesToHHmm(availability.endMinuteOfDay)
                    }}
                  </div>
                  <div class="text-blue-100 text-[10px]">{{ availability.availableMinutes }}m</div>
                </div>
              </div>
            } @else {
              <div
                class="border-r border-b border-gray-200 p-1 min-h-[56px] cursor-pointer hover:bg-gray-50 transition-colors"
                [class.bg-gray-50]="$even"
                (click)="onCellClick({ driver, date, availability: null })"
              >
                <div class="text-gray-400 text-center text-xs py-2">-</div>
              </div>
            }
          }
        }
      </div>
    </div>
  }

  <!-- Edit Dialog -->
  <p-dialog
    [header]="
      selectedCell()
        ? 'Availability: ' +
          selectedCell()!.driver.name +
          ' - ' +
          formatDateFull(selectedCell()!.date)
        : 'Set Availability'
    "
    [modal]="true"
    [style]="{ width: '450px' }"
    [appendTo]="'body'"
    [baseZIndex]="10000"
    (onHide)="showDialog.set(false)"
    [(visible)]="showDialogValue"
  >
    @if (selectedCell(); as cell) {
      <div class="flex flex-col gap-4">
        <div>
          <label class="block text-sm font-medium mb-1">Start Time</label>
          <p-select
            optionLabel="label"
            optionValue="value"
            class="w-full"
            [options]="timeOptions()"
            [appendTo]="'body'"
            [(ngModel)]="dialogForm().startMinuteOfDay"
          />
        </div>
        <div>
          <label class="block text-sm font-medium mb-1">End Time</label>
          <p-select
            optionLabel="label"
            optionValue="value"
            class="w-full"
            [options]="timeOptions()"
            [appendTo]="'body'"
            [(ngModel)]="dialogForm().endMinuteOfDay"
          />
        </div>
        @if (cell.availability) {
          <div class="text-sm text-gray-600">
            Current: {{ minutesToHHmm(cell.availability.startMinuteOfDay) }} -
            {{ minutesToHHmm(cell.availability.endMinuteOfDay) }}
            ({{ cell.availability.availableMinutes }} minutes)
          </div>
        }
      </div>
    }
    <ng-template pTemplate="footer">
      @if (selectedCell()?.availability) {
        <p-button
          label="Clear"
          severity="danger"
          [loading]="loading()"
          (onClick)="clearAvailability()"
        />
      }
      <p-button label="Cancel" severity="secondary" (onClick)="showDialog.set(false)" />
      <p-button label="Save" [loading]="loading()" (onClick)="saveAvailability()" />
    </ng-template>
  </p-dialog>

  <!-- Driver Dialog -->
  <p-dialog
    [header]="'Edit Driver'"
    [modal]="true"
    [style]="{ width: '600px' }"
    [appendTo]="'body'"
    (onHide)="showDriverDialog.set(false)"
    [(visible)]="showDriverDialogValue"
  >
    <div class="flex flex-col gap-4">
      <div>
        <label class="block text-sm font-medium mb-1">ErpId *</label>
        <p-inputNumber class="w-full" [useGrouping]="false" [(ngModel)]="driverForm().erpId" />
      </div>
      <div>
        <label class="block text-sm font-medium mb-1">Name *</label>
        <input pInputText class="w-full" [(ngModel)]="driverForm().name" />
      </div>
      <div>
        <label class="block text-sm font-medium mb-1">Start Address</label>
        <input pInputText class="w-full" [(ngModel)]="driverForm().startAddress" />
      </div>
      <div>
        <label class="block text-sm font-medium mb-1"
          >Owner <span class="text-red-500">*</span></label
        >
        <p-select
          optionLabel="name"
          optionValue="id"
          placeholder="Select Owner"
          [options]="owners()"
          [ngModel]="driverForm().ownerId"
          [style]="{ width: '100%' }"
          [appendTo]="'body'"
          (ngModelChange)="onDriverFormOwnerChange($event)"
        />
      </div>
      <div>
        <label class="block text-sm font-medium mb-1">Service Types</label>
        <p-multiSelect
          optionLabel="name"
          optionValue="id"
          placeholder="Select service types"
          [options]="driverFormServiceTypes()"
          [ngModel]="driverForm().serviceTypeIds"
          [filter]="true"
          [display]="'chip'"
          [style]="{ width: '100%' }"
          [appendTo]="'body'"
          [disabled]="!driverForm().ownerId"
          (ngModelChange)="onDriverFormServiceTypesChange($event)"
        />
      </div>
      <div class="grid grid-cols-2 gap-4">
        <div>
          <label class="block text-sm font-medium mb-1">Latitude *</label>
          <p-inputNumber
            class="w-full"
            [minFractionDigits]="6"
            [maxFractionDigits]="6"
            [(ngModel)]="driverForm().startLatitude"
          />
        </div>
        <div>
          <label class="block text-sm font-medium mb-1">Longitude *</label>
          <p-inputNumber
            class="w-full"
            [minFractionDigits]="6"
            [maxFractionDigits]="6"
            [(ngModel)]="driverForm().startLongitude"
          />
        </div>
      </div>
      <div class="grid grid-cols-2 gap-4">
        <div>
          <label class="block text-sm font-medium mb-1">Default Service Minutes</label>
          <p-inputNumber
            class="w-full"
            [min]="1"
            [max]="240"
            [(ngModel)]="driverForm().defaultServiceMinutes"
          />
        </div>
        <div>
          <label class="block text-sm font-medium mb-1">Max Work Minutes/Day</label>
          <p-inputNumber
            class="w-full"
            [min]="60"
            [max]="900"
            [(ngModel)]="driverForm().maxWorkMinutesPerDay"
          />
        </div>
      </div>
      <div>
        <label class="flex items-center gap-2">
          <input type="checkbox" [(ngModel)]="driverForm().isActive" />
          <span>Active</span>
        </label>
      </div>
    </div>
    <ng-template pTemplate="footer">
      <p-button label="Cancel" severity="secondary" (onClick)="showDriverDialog.set(false)" />
      <p-button label="Save" [loading]="loading()" (onClick)="saveDriver()" />
    </ng-template>
  </p-dialog>

  <p-dialog
    [header]="'Availability conflicts'"
    [modal]="true"
    [style]="{ width: '720px' }"
    [appendTo]="'body'"
    (onHide)="showConflictDialog.set(false)"
    [(visible)]="showConflictDialogValue"
  >
    @if (availabilityConflicts().length === 0) {
      <div class="text-sm text-gray-600">No conflicts to show.</div>
    } @else {
      <div class="max-h-[420px] overflow-auto">
        <table class="w-full text-sm">
          <thead>
            <tr class="text-left text-gray-600">
              <th class="pb-2 pr-4">Driver</th>
              <th class="pb-2 pr-4">Date</th>
              <th class="pb-2">Reason</th>
            </tr>
          </thead>
          <tbody>
            @for (conflict of availabilityConflicts(); track conflict.rowRef ?? conflict.date ?? conflict.driverName ?? conflict.email) {
              <tr class="border-t border-gray-200 align-top">
                <td class="py-2 pr-4">{{ getConflictDriverLabel(conflict) }}</td>
                <td class="py-2 pr-4">{{ getConflictDateLabel(conflict) }}</td>
                <td class="py-2">{{ conflict.reason || 'Conflict detected.' }}</td>
              </tr>
            }
          </tbody>
        </table>
      </div>
    }
    <ng-template pTemplate="footer">
      <p-button label="Close" severity="secondary" (onClick)="showConflictDialog.set(false)" />
    </ng-template>
  </p-dialog>

  <p-confirmDialog />
  <p-toast />
</div>
