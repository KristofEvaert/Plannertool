<p-toast />
<div class="pt-20 px-6 pb-6">
  <div class="max-w-6xl mx-auto space-y-4">
    <div class="flex items-center justify-between">
      <div class="flex items-center gap-2">
        <h1 class="text-2xl font-bold text-gray-900">Weight Templates</h1>
        <app-help-manual [sectionId]="'weight-templates'" />
      </div>
    </div>
    <div class="flex flex-wrap items-end justify-between gap-4">
      <div class="flex flex-wrap items-end gap-4">
        @if (isSuperAdmin()) {
          <div class="w-64">
            <label class="block text-sm font-semibold mb-1">Owner</label>
            <p-select
              optionLabel="label"
              optionValue="value"
              placeholder="All owners"
              [options]="ownerFilterOptions()"
              [ngModel]="selectedOwnerId()"
              [filter]="true"
              (ngModelChange)="selectedOwnerId.set($event)"
            />
          </div>
        }
        <label class="flex items-center gap-2 text-sm font-semibold">
          <p-checkbox
            inputId="include-inactive"
            [binary]="true"
            [ngModel]="includeInactive()"
            (ngModelChange)="includeInactive.set($event)"
          />
          <span>Include inactive</span>
        </label>
      </div>
      <p-button
        label="Add template"
        icon="pi pi-plus"
        [disabled]="!canManageTemplates()"
        (onClick)="openCreate()"
      />
    </div>

    <div class="card p-3">
      <p-table [value]="templates()" [loading]="loading()">
        <ng-template pTemplate="header">
          <tr>
            <th>Name</th>
            <th>Owner</th>
            <th>Algorithm</th>
            <th>Due date priority</th>
            <th>Worktime deviation</th>
            <th>Active</th>
            <th class="text-right">Actions</th>
          </tr>
        </ng-template>
        <ng-template let-template pTemplate="body">
          <tr>
            <td class="font-medium">{{ template.name }}</td>
            <td>{{ ownerName(template.ownerId) }}</td>
            <td>{{ template.algorithmType }}</td>
            <td>{{ template.dueDatePriority }}%</td>
            <td>{{ template.worktimeDeviationPercent }}%</td>
            <td>
              <p-tag [value]="template.isActive ? 'Active' : 'Inactive'" />
            </td>
            <td class="text-right">
              @if (canEditTemplate(template)) {
                <div class="flex justify-end gap-2">
                  <p-button
                    label="Edit"
                    size="small"
                    severity="secondary"
                    [outlined]="true"
                    (onClick)="openEdit(template)"
                  />
                  <p-button
                    label="Delete"
                    size="small"
                    severity="danger"
                    (onClick)="delete(template)"
                  />
                </div>
              } @else {
                <span class="text-sm text-gray-400">Read-only</span>
              }
            </td>
          </tr>
        </ng-template>
      </p-table>
    </div>
  </div>
</div>

<p-dialog
  [modal]="true"
  [closable]="true"
  [style]="{ width: '640px' }"
  [header]="isEdit() ? 'Edit weight template' : 'Add weight template'"
  [(visible)]="showDialogValue"
>
  <div class="grid grid-cols-1 md:grid-cols-2 gap-3">
    <div class="md:col-span-2">
      <label class="block text-sm font-semibold mb-1">Name</label>
      <input
        pInputText
        class="w-full"
        [ngModel]="form().name"
        (ngModelChange)="onFormChange('name', $event)"
      />
    </div>

    @if (isSuperAdmin()) {
      <div>
        <label class="block text-sm font-semibold mb-1">Owner</label>
        <p-select
          optionLabel="label"
          optionValue="value"
          placeholder="Select owner"
          [options]="ownerOptions()"
          [ngModel]="form().ownerId"
          [filter]="true"
          [appendTo]="'body'"
          (ngModelChange)="onFormChange('ownerId', $event)"
        />
      </div>
    }

    @if (canManageTemplates()) {
      <div>
        <label class="block text-sm font-semibold mb-1">Algorithm</label>
        <p-select
          optionLabel="label"
          optionValue="value"
          placeholder="Select algorithm"
          [options]="algorithmOptions"
          [ngModel]="form().algorithmType"
          [appendTo]="'body'"
          (ngModelChange)="onFormChange('algorithmType', $event)"
        />
      </div>
    }

    <div>
      <label class="block text-sm font-semibold mb-1">Due date priority</label>
      <div class="flex items-center gap-3">
        <input
          type="range"
          min="0"
          max="100"
          step="1"
          class="w-full"
          [ngModel]="form().dueDatePriority"
          (ngModelChange)="onFormChange('dueDatePriority', $event)"
        />
        <span class="text-sm font-semibold w-12 text-right">{{ form().dueDatePriority }}%</span>
      </div>
    </div>

    <div>
      <label class="block text-sm font-semibold mb-1">Worktime deviation</label>
      <div class="flex items-center gap-3">
        <input
          type="range"
          min="0"
          max="50"
          step="1"
          class="w-full"
          [ngModel]="form().worktimeDeviationPercent"
          (ngModelChange)="onFormChange('worktimeDeviationPercent', $event)"
        />
        <span class="text-sm font-semibold w-12 text-right"
          >{{ form().worktimeDeviationPercent }}%</span
        >
      </div>
    </div>

    <div class="flex items-center gap-2 md:col-span-2 mt-4">
      <p-checkbox
        inputId="template-active"
        [binary]="true"
        [ngModel]="form().isActive"
        (ngModelChange)="onFormChange('isActive', $event)"
      />
      <label for="template-active" class="text-sm">Active</label>
    </div>
  </div>

  <ng-template pTemplate="footer">
    <div class="flex justify-end gap-2">
      <p-button
        label="Cancel"
        severity="secondary"
        [outlined]="true"
        (onClick)="showDialog.set(false)"
      />
      <p-button label="Save" [loading]="loading()" (onClick)="save()" />
    </div>
  </ng-template>
</p-dialog>
